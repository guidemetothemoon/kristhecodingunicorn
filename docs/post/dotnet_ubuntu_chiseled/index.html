<!DOCTYPE html>
<html
  dir="ltr"
  lang="en"
  data-theme="dark"
  
    class="html theme--dark"
  
><head>
  <title>
    Kris - The Coding Unicorn
        |
        [üéÑ.NET Advent CalendarüéÑ] Strengthening security posture of containerized .NET applications with Chiseled Ubuntu Containers
      

    

  </title>

  
  <meta charset="utf-8" /><meta name="generator" content="Hugo 0.115.4"><meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <meta name="author" content="Kris - The Coding Unicorn" />
  <meta
    name="description"
    content="This blog post explains how you can run containerized .NET applications in a more secure manner with Chiseled Ubuntu Containers"
  />
  
    <meta name="google-site-verification" content="OQXmc6vSYyn6I-aGZoI6GH2M6CdM4NjmwulDqvvNCQA" />
  
    
    
    <link
      rel="stylesheet"
      href="/scss/main.min.772eefee9824c26da5d3828c2507ea318c8e7a37b0b1d18cd4f224edc2755fea.css"
      integrity="sha256-dy7v7pgkwm2l04KMJQfqMYyOejewsdGM1PIk7cJ1X&#43;o="
      crossorigin="anonymous"
      type="text/css"
    />
  

  
  <link
    rel="stylesheet"
    href="/css/markupHighlight.min.73ccfdf28df555e11009c13c20ced067af3cb021504cba43644c705930428b00.css"
    integrity="sha256-c8z98o31VeEQCcE8IM7QZ688sCFQTLpDZExwWTBCiwA="
    crossorigin="anonymous"
    type="text/css"
  />
  
    
    
    <link
      rel="stylesheet"
      href="/css/syntax.min.dd17d6ee5bba73cc3f814469aae150232f0fc13a2038e79772f4d25565b5a23c.css"
      integrity="sha256-3RfW7lu6c8w/gURpquFQIy8PwTogOOeXcvTSVWW1ojw="
      crossorigin="anonymous"
      media="screen"
    />
  
  
  <link
    rel="stylesheet"
    href="/fontawesome/css/fontawesome.min.7d272de35b410fb165377550cdf9c4d3a80fbbcc961e111914e4d5c0eaf5729f.css"
    integrity="sha256-fSct41tBD7FlN3VQzfnE06gPu8yWHhEZFOTVwOr1cp8="
    crossorigin="anonymous"
    type="text/css"
  />
  
  <link
    rel="stylesheet"
    href="/fontawesome/css/solid.min.55d8333481b07a08e07cf6f37319753a2b47e99f4c395394c5747b48b495aa9b.css"
    integrity="sha256-VdgzNIGwegjgfPbzcxl1OitH6Z9MOVOUxXR7SLSVqps="
    crossorigin="anonymous"
    type="text/css"
  />
  
  <link
    rel="stylesheet"
    href="/fontawesome/css/regular.min.a7448d02590b43449364b6b5922ed9af5410abb4de4238412a830316dedb850b.css"
    integrity="sha256-p0SNAlkLQ0STZLa1ki7Zr1QQq7TeQjhBKoMDFt7bhQs="
    crossorigin="anonymous"
    type="text/css"
  />
  
  <link
    rel="stylesheet"
    href="/fontawesome/css/brands.min.9ed75a5d670c953fe4df935937674b4646f92674367e9e66eb995bb04e821647.css"
    integrity="sha256-ntdaXWcMlT/k35NZN2dLRkb5JnQ2fp5m65lbsE6CFkc="
    crossorigin="anonymous"
    type="text/css"
  />
  
  <link rel="shortcut icon" href="/favicons/favicon.ico" type="image/x-icon" />
  <link rel="apple-touch-icon" sizes="180x180" href="/favicons/apple-touch-icon.png" />
  <link rel="icon" type="image/png" sizes="32x32" href="/favicons/favicon-32x32.png" />
  <link rel="icon" type="image/png" sizes="16x16" href="/favicons/favicon-16x16.png" />

  <link rel="canonical" href="https://kristhecodingunicorn.com/post/dotnet_ubuntu_chiseled/" />

  
  
  
  
  <script
    type="text/javascript"
    src="/js/anatole-header.min.f9132794301a01ff16550ed66763482bd848f62243d278f5e550229a158bfd32.js"
    integrity="sha256-&#43;RMnlDAaAf8WVQ7WZ2NIK9hI9iJD0nj15VAimhWL/TI="
    crossorigin="anonymous"
  ></script>

  

  <script
  async
  defer
  src="https://umami-guidemetothemoon.vercel.app/18352c56e4b049f69a24fbae0ca62b4f.js"
  data-website-id="9dd30a0e-3918-4513-b61d-4dd81e20ed4b"
></script>



  
  <meta name="twitter:card" content="summary_large_image"/>
<meta name="twitter:image" content="https://kristhecodingunicorn.com/images/site-feature-image.png"/>

<meta name="twitter:title" content="[üéÑ.NET Advent CalendarüéÑ] Strengthening security posture of containerized .NET applications with Chiseled Ubuntu Containers"/>
<meta name="twitter:description" content="This blog post explains how you can run containerized .NET applications in a more secure manner with Chiseled Ubuntu Containers"/>



  
  <meta property="og:title" content="[üéÑ.NET Advent CalendarüéÑ] Strengthening security posture of containerized .NET applications with Chiseled Ubuntu Containers" />
<meta property="og:description" content="This blog post explains how you can run containerized .NET applications in a more secure manner with Chiseled Ubuntu Containers" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://kristhecodingunicorn.com/post/dotnet_ubuntu_chiseled/" /><meta property="og:image" content="https://kristhecodingunicorn.com/images/site-feature-image.png"/><meta property="article:section" content="post" />
<meta property="article:published_time" content="2022-12-19T00:00:00+00:00" />
<meta property="article:modified_time" content="2022-12-19T00:00:00+00:00" /><meta property="og:site_name" content="Kris - The Coding Unicorn" />



  
  
  
  
  <script type="application/ld+json">
    {
        "@context": "http://schema.org",
        "@type": "BlogPosting",
        "articleSection": "post",
        "name": "[üéÑ.NET Advent CalendarüéÑ] Strengthening security posture of containerized .NET applications with Chiseled Ubuntu Containers",
        "headline": "[üéÑ.NET Advent CalendarüéÑ] Strengthening security posture of containerized .NET applications with Chiseled Ubuntu Containers",
        "alternativeHeadline": "",
        "description": "
      This blog post explains how you can run containerized .NET applications in a more secure manner with Chiseled Ubuntu Containers


    ",
        "inLanguage": "en",
        "isFamilyFriendly": "true",
        "mainEntityOfPage": {
            "@type": "WebPage",
            "@id": "https:\/\/kristhecodingunicorn.com\/post\/dotnet_ubuntu_chiseled\/"
        },
        "author" : {
            "@type": "Person",
            "name": "Kristina D."
        },
        "creator" : {
            "@type": "Person",
            "name": "Kristina D."
        },
        "accountablePerson" : {
            "@type": "Person",
            "name": "Kristina D."
        },
        "copyrightHolder" : {
            "@type": "Person",
            "name": "Kristina D."
        },
        "copyrightYear" : "2022",
        "dateCreated": "2022-12-19T00:00:00.00Z",
        "datePublished": "2022-12-19T00:00:00.00Z",
        "dateModified": "2022-12-19T00:00:00.00Z",
        "publisher":{
            "@type":"Organization",
            "name": "Kristina D.",
            "url": "https://kristhecodingunicorn.com",
            "logo": {
                "@type": "ImageObject",
                "url": "https:\/\/kristhecodingunicorn.com\/favicons\/favicon-32x32.png",
                "width":"32",
                "height":"32"
            }
        },
        "image": 
      [
        
        "https://kristhecodingunicorn.com/images/site-feature-image.png"


      
      ]

    ,
        "url" : "https:\/\/kristhecodingunicorn.com\/post\/dotnet_ubuntu_chiseled\/",
        "wordCount" : "3141",
        "genre" : [ ],
        "keywords" : [ 
      
      "dotnet"

    
      
        ,

      
      "microservices"

    
      
        ,

      
      "containers"

    
      
        ,

      
      "ubuntu"

    
      
        ,

      
      "kubernetes"

    ]
    }
  </script>


</head>
<body class="body">
    <div class="wrapper">
      <aside
        
          class="wrapper__sidebar"
        
      ><div
  class="sidebar
    animated fadeInDown
  "
>
  <div class="sidebar__content">
    <div class="sidebar__introduction">
      <img
        class="sidebar__introduction-profileimage"
        src="/images/profile.webp"
        alt="profile picture"
      />
      
        <div class="sidebar__introduction-title">
          <a href="/">Kris - The Coding Unicorn</a>
        </div>
      
      <div class="sidebar__introduction-description">
        <p>Welcome to my tech corner! ü§ó <br />I preach about all things cloud native, green tech and cats üêà <br />Check "Blog" for new posts and "About" for my community involvement ü¶Ñ</p>
      </div>
    </div>
    <ul class="sidebar__list">
      
        <li class="sidebar__list-item">
          <a
            href="https://linkfree.io/guidemetothemoon"
            target="_blank"
            rel="noopener me"
            aria-label="Let&#39;s connect!"
            title="Let&#39;s connect!"
          >
            <i class="fas fa-cat fa-2x" aria-hidden="true"></i>
          </a>
        </li>
      
        <li class="sidebar__list-item">
          <a
            href="https://www.buymeacoffee.com/kristhecodingu1"
            target="_blank"
            rel="noopener me"
            aria-label="Help me buy supplies for homeless animals &lt;3"
            title="Help me buy supplies for homeless animals &lt;3"
          >
            <i class="fas fa-hand-holding-heart fa-2x" aria-hidden="true"></i>
          </a>
        </li>
      
        <li class="sidebar__list-item">
          <a
            href="https://feedly.com/i/subscription/feed%2Fhttps%3A%2F%2Fkristhecodingunicorn.com%2Findex.xml"
            target="_blank"
            rel="noopener me"
            aria-label="RSS feed"
            title="RSS feed"
          >
            <i class="fas fa-rss fa-2x" aria-hidden="true"></i>
          </a>
        </li>
      
    </ul>
  </div>
  
    <div id="wcb"  
        
        class="carbonbadge wcb-d"
        
    >
    </div>
    <script src="https://unpkg.com/website-carbon-badges@1.1.3/b.min.js" defer></script>
  <footer class="footer footer__sidebar">
  <ul class="footer__list">
    <li class="footer__item">
      &copy;
      
        2023 - Powered by Hugo
      
    </li>
    
  </ul>
</footer>
  
  <script
    type="text/javascript"
    src="/js/medium-zoom.min.1248fa75275e5ef0cbef27e8c1e27dc507c445ae3a2c7d2ed0be0809555dac64.js"
    integrity="sha256-Ekj6dSdeXvDL7yfoweJ9xQfERa46LH0u0L4ICVVdrGQ="
    crossorigin="anonymous"
  ></script></div>
</aside>
      <main
        
          class="wrapper__main"
        
      >
        <header class="header"><div
  class="
    animated fadeInDown
  "
>
  <a role="button" class="navbar-burger" data-target="navMenu" aria-label="menu" aria-expanded="false">
    <span aria-hidden="true" class="navbar-burger__line"></span>
    <span aria-hidden="true" class="navbar-burger__line"></span>
    <span aria-hidden="true" class="navbar-burger__line"></span>
  </a>
  <nav class="nav">
    <ul class="nav__list" id="navMenu">
      
      
        
        
          <li class="nav__list-item">
            
            <a
              
              href="/"
              
              title=""
              >Home</a
            >
          </li>
        

      
        
        
          <li class="nav__list-item">
            
            <a
              
              href="/post/"
              
              title=""
              >Blog</a
            >
          </li>
        

      
        
        
          <li class="nav__list-item">
            
            <a
              
              href="/techtips/"
              
              title=""
              >Tech Tips</a
            >
          </li>
        

      
        
        
          <li class="nav__list-item">
            
            <a
              
              href="/public/"
              
              title=""
              >Public Talks and Publications</a
            >
          </li>
        

      
        
        
          <li class="nav__list-item">
            
            <a
              
              href="/about/"
              
              title=""
              >About</a
            >
          </li>
        

      
        
        
          <li class="nav__list-item">
            
            <a
              
              href="/contact/"
              
              title=""
              >Contact</a
            >
          </li>
        

      
    </ul>
    <ul class="nav__list nav__list--end">
      
      
    </ul>
  </nav>
</div>
</header>
  <div
    class="post 
      animated fadeInDown
    "
  >
    
    <div class="post__content">
      <h1>[üéÑ.NET Advent CalendarüéÑ] Strengthening Security Posture of Containerized .NET Applications With Chiseled Ubuntu Containers</h1>
      
        <ul class="post__meta">
          <li class="post__meta-item">
            <em class="fas fa-calendar-day post__meta-icon"></em>
            <span class="post__meta-text"
              >
                
                  19/12/2022
                

              
            </span>
          </li>
          <li class="post__meta-item">
            <em class="fas fa-stopwatch post__meta-icon"></em>
            <span class="post__meta-text">15-minute read</span>
          </li>
        </ul>
      <div class="toc">
  <nav id="TableOfContents">
  <ul>
    <li><a href="#introduction">Introduction</a></li>
    <li><a href="#container-security---pitfalls-and-must-dos">Container Security - pitfalls and must do&rsquo;s</a>
      <ul>
        <li><a href="#containers-and-root-user">Containers and root user</a>
          <ul>
            <li><a href="#running-containers-as-unprivileged-user">Running containers as unprivileged user</a></li>
            <li><a href="#rootless-containers">Rootless Containers</a></li>
            <li><a href="#running-containers-with-unprivileged-user-in-kubernetes">Running containers with unprivileged user in Kubernetes</a></li>
          </ul>
        </li>
        <li><a href="#supply-chain-and-third-party-dependencies">Supply chain and third-party dependencies</a></li>
        <li><a href="#summary-on-mitigating-common-container-security-pitfalls">Summary on mitigating common container security pitfalls</a></li>
      </ul>
    </li>
    <li><a href="#chiseled-ubuntu-containers--net">Chiseled Ubuntu Containers &amp;&amp; .NET</a></li>
    <li><a href="#example-porting-cat-encyclopedia-app-to-net-7-and-chiseled-ubuntu-containers-and-deploying-on-aks">Example: Porting Cat Encyclopedia app to .NET 7 and Chiseled Ubuntu Containers and deploying on AKS</a></li>
    <li><a href="#additional-resources">Additional resources</a></li>
  </ul>
</nav>
</div>
<p>üéÑ<em><strong>This blog post is also a contribution to .NET Advent Calendar where during December, experts from the tech community share their knowledge about .NET related topics. You&rsquo;re welcome to check out all the contributions here:</strong></em> <a href="https://dotnet.christmas/">.NET Advent Calendar 2022</a></p>
<h2 id="introduction">Introduction</h2>
<p>In the modern world of cloud native application development more and more organizations are moving away from classic bare metal deployments and are adopting technologies like containerization and orchestration for a more efficient and sustainable way to deploy applications at scale on different types of infrastructure.</p>
<p>Even though the way we&rsquo;re packaging and deploying applications is changing, the importance of continuously ensuring and strengthening security posture of our systems is still extremely crucial. With containers and container orchestrators like Kubernetes, security controls must be implemented at multiple levels and it&rsquo;s important to understand what those levels are once you start containerizing your applications. üîë</p>
<p>In this blog post I would like to talk about how you can minimize the attack surface of the containerized .NET applications with Chiseled Ubuntu Containers which have recently introduced support for .NET 6 and now .NET 7 applications targeting Linux operating system.</p>
<h2 id="container-security---pitfalls-and-must-dos">Container Security - pitfalls and must do&rsquo;s</h2>
<p>Before we dive into Chiseled Ubuntu Containers let&rsquo;s set the baseline by looking at some pitfalls when it comes to container security and what are the must do&rsquo;s in order to protect containers against those.</p>
<h3 id="containers-and-root-user">Containers and root user</h3>
<p>One of the most important security improvements that you can have in place for containers is to configure them to run with a non-root user. You can also consider using rootless containers or rootless mode if it&rsquo;s possible and is supported, for additional container hardening.</p>
<h4 id="running-containers-as-unprivileged-user">Running containers as unprivileged user</h4>
<p>By default if you don&rsquo;t provide a user that container should run with, root user will be used. Unless you&rsquo;re using rootless containers, which we will talk about shortly. The big security risk here is that container has access to the host system (a server, a VM an application container is running on, a Node in Kubernetes) and can access and modify content on the host as a root user, with the same level of permissions! If there&rsquo;s a vulnerability in the application that&rsquo;s running in a container or if a container is misconfigured and malicious actor figures it out, he/she may be able to exploit it and get access to the host system with root user&rsquo;s level of permissions! Just imagine how harmful this can be - I wouldn&rsquo;t wish anyone to experience that. üôÄ</p>
<p>Unfortunately quite many third-party images still use root user by default, but we can see that the situation has started to change. More and more third-party services have started to use an unpriveleged user by default in their container images or are offering an alternative image which is unpriveleged. A good example here is NGINX: they offer both a regular image which uses root user by default, and an unpriveleged image which uses a user with minimal level of permissions to run NGINX server in a container: <a href="https://hub.docker.com/r/nginxinc/nginx-unprivileged">nginxinc/nginx-unprivileged</a>. All in all, it will take time to get to a point where most of the container images out there will run with unprivileged user by default.</p>
<p>When a third-party image doesn&rsquo;t provide a possibility to run with non-root user, it may be possible to create a custom image based on the original image where you can explicitly define an unprivileged user that container will run with. But there are cases where this is not that easy to do: for example, default ASP.NET image doesn&rsquo;t let you off that easily: <a href="https://github.com/dotnet/aspnetcore/issues/4699">Unable to start Kestrel. System.Net.Sockets.SocketException (13): Permission denied while running alpine as non root user</a>. Often the reason is the default port that container is binded to - there is a restriction in Linux OS which requires a root user if you&rsquo;re using a port that is lower than 1024. Port 80 is often used by default which falls under this limitation. Shortly we&rsquo;ll see how Chiseled Ubuntu Containers come to the rescue in this case!üò∫</p>
<p>Once you start using third-party images it&rsquo;s important that you do your research in order to understand if those images use root user by default or not, and which options are available in order to configure the image in the most secure way. When building your own container images, do ensure that you&rsquo;re not using a root user unless it&rsquo;s absolutely necessary. It&rsquo;s also a good idea to implement checks for this type of misconfiguration, for example with <a href="https://learn.microsoft.com/en-us/azure/governance/policy/overview">Azure Policy</a>. Using policies as an additional security control can help you automate detection of different types of misconfigurations and alerting in case a fix is required.</p>
<h4 id="rootless-containers">Rootless Containers</h4>
<p>For additional security and isolation you can consider adopting rootless containers, if it&rsquo;s supported for your use case. Rootless containers fully eliminate access to the root user on the host system that a container runs on. In this case, both the container itself and container runtime are running without root privileges. Even if you forget to specify a non-root user to run containers with, or you may need a root user to perform specific operations inside the container, outside of the container you will not have root user privileges, i.e. you will not be able to access the host system as root. In this case, if your container is compromised and an attacker will be able to get access to the host system, he/she will not be able to perform any actions with root privileges on the host.</p>
<p>Container engines like Podman have been offering rootless containers for a while now. It was harder to offer support for this by container engines which required a daemon in order to create and manage containers - for example, Docker is one of the container engines that didn&rsquo;t support it until 2020. With Docker version 20.10.0 support for rootless mode has been officially released in GA. With rootless mode in Docker even Docker daemon doesn&rsquo;t require root privileges. You can read more about rootless mode in Docker here: <a href="https://docs.docker.com/engine/security/rootless">Run the Docker daemon as a non-root user (Rootless mode)</a></p>
<p>Rootless containers/rootless mode is a great security enhancement in the containerization world, but it has quite a few limitations which at this point narrows down the use cases where you will be able to adopt it. If you would like to learn more, you can check out this link: <a href="https://rootlesscontaine.rs/getting-started/">Rootless Containers</a></p>
<h4 id="running-containers-with-unprivileged-user-in-kubernetes">Running containers with unprivileged user in Kubernetes</h4>
<p>If you&rsquo;re planning on running containers in Kubernetes, in addition to defining an unprivileged user when building a container image you should also use Security Context. Security Context defines privileges and access control settings for containers that are running inside a Pod in a Kubernetes cluster, and for the Pod as a whole (a Pod can have multiple containers running in it). With Security Context you can not only define which user to run the container/Pod with but also if it can be run in privileged mode, gain more privileges than it&rsquo;s parent process, etc.</p>
<p>Using Security Context will ensure that not only the container is built with the correct default user with minimal privileges, but also that the user is correctly set when the container is running in a Pod in a Kubernetes cluster.</p>
<p>You can read more about Security Context in Kubernetes here: <a href="https://kubernetes.io/docs/tasks/configure-pod-container/security-context/">Configure a Security Context for a Pod or Container</a></p>
<h3 id="supply-chain-and-third-party-dependencies">Supply chain and third-party dependencies</h3>
<p>In most cases, when packaging your applications in a container you will need to use a third-party base image that is built upon an operating system of your choice and has necessary frameworks and tools installed that your application may need in order to run successfully. For example, if you want to run an ASP.NET 6 application on Linux, you would need a base image that includes a Linux distribution of your choice and has ASP.NET 6 installed. In many cases though third-party images may contain lots of unnecessary tools and libraries that your application doesn&rsquo;t need. Having lots of unnecessary components installed results in a broader attack surface for malicious actors to explore. In addition, the more components you have, the more security vulnerabilities you may need to handle.</p>
<p>In order to mitigate this you should use minimal container images that include only those tools and utilities that are absolutely necessary in order for your application to run. If your application requires additional tools and libraries you can granularly define what to include on top of the minimal package as part of the container build phase. Minimal container images definitely have security benefits, but including only what&rsquo;s needed may also significantly reduce the total container image size which results in faster image download and container startup time.</p>
<h3 id="summary-on-mitigating-common-container-security-pitfalls">Summary on mitigating common container security pitfalls</h3>
<p>To sum it up, in order to strengthen container security and mitigate common pitfalls you should:</p>
<ul>
<li>üõ° Define a default unprivileged user that container will run with;</li>
<li>üõ° Bind to ports higher than 1024 - if a lower port is required, a proxy can be used;</li>
<li>üõ° Be conscious when choosing third-party images: choose unprivileged image or build an unprivileged custom image on top of the original image;</li>
<li>üõ° Build and use minimal images - install only what&rsquo;s needed in order to successfully run your application in a container;</li>
<li>üõ° In Kubernetes, use SecurityContext to ensure that Pods and application containers running in Pods comply with least privilege principle;</li>
<li>üõ° Implement security scanning tools like Trivy and use policies to detect and alert on this type of misconfiguration, for example with Azure Policy;</li>
</ul>
<p>Now, let&rsquo;s take a look at what Chiseled Ubuntu Containers are and how they can make it easier for us to mitigate common container security pitfalls mentioned above in containerized .NET applications.üòº</p>
<h2 id="chiseled-ubuntu-containers--net">Chiseled Ubuntu Containers &amp;&amp; .NET</h2>
<p>In August 2022 built-in support for .NET 6 in Ubuntu was officially announced. Built-in support in this case means that you can now install .NET 6 on Ubuntu 22.04 with <code>apt install dotnet6</code> ! This is quite cool in itself. üò∫ In addition support for .NET with Chiseled Ubuntu Containers was officially released which is what we&rsquo;re going to look into now.</p>
<blockquote>
<p><em><strong>Please note that at the point of writing this blog post .NET with Chiseled Ubuntu Containers is still in preview and should not be used in production environments. This blog post will be updated once the functionality reaches GA.</strong></em></p>
</blockquote>
<p><strong>What are Chiseled Ubuntu Containers?</strong> ü§î</p>
<p>Chiseled Ubuntu Containers are a minimal version of Ubuntu image with enhanced security:</p>
<ul>
<li>‚úÖ There is no shell or package manager installed;</li>
<li>‚úÖ Only needed libraries and utilities are installed;</li>
<li>‚úÖ Uses unprivileged, non-root user by default;</li>
</ul>
<p>Chiseled Ubuntu Containers (CUC) are available from Ubuntu version 22.04 (Jammy). CUC are built based on the original Ubuntu 22.04 OS, but are heavily stripped to include only what&rsquo;s necessary, and are extra hardened in terms of security following least privilege principle. An advantage of CUC is that it significantly reduces the attack surface and total amount of security vulnerabilities that you may need to handle. Another advantage is the total image size - compared to the original ASP.NET 6 Ubuntu Jammy image, ASP.NET 6 Chiseled Ubuntu Container image is at least 100MB smaller! üòª</p>
<p>If you haven&rsquo;t worked with minimal container images before it will require a mindset change and some getting used to. Since there&rsquo;s no shell installed you will not be able to just log into the container and start running shell commands like you can do with regular images. If you think about it though, in the real-life production world this is not something that you would want to be able to do either so, using this type of images can definitely help you with shifting left on security by creating and managing containers in a secure way from the start.</p>
<p>Chiseled Ubuntu Containers come with some limitations which you should be aware of and prepare for:</p>
<ul>
<li>‚ö†Ô∏è As mentioned in the above section, some operations which require root privileges like binding to privileged ports (&lt; 1024) are not allowed, but there are alternative solutions available. If you nevertheless require root user privileges, you can still add a root user to CUC, but it is a security-related decision that you need to evaluate in your specific use case;</li>
<li>‚ö†Ô∏è Chiseled images with .NET SDK are currently not supported;</li>
<li>‚ö†Ô∏è Since this is a relatively new product not much official documentation is available yet, but I believe that once it reaches GA and gets adopted by a broader tech community, more information, recommendations, tips and tricks will come.</li>
</ul>
<p>Now, let&rsquo;s see Chiseled Ubuntu Containers in action!üòº</p>
<h2 id="example-porting-cat-encyclopedia-app-to-net-7-and-chiseled-ubuntu-containers-and-deploying-on-aks">Example: Porting Cat Encyclopedia app to .NET 7 and Chiseled Ubuntu Containers and deploying on AKS</h2>
<p>If you&rsquo;ve seen some of my talks you have probably seen my demo application that spreads lots of love for cats - Cat Encyclopedia. üòÅ This is a simple ASP.NET 6 web application that initially was using Ubuntu Jammy (22.04) base image. Now, let&rsquo;s port it to ASP.NET 6 Chiseled Ubuntu Container image and finally upgrade it to ASP.NET 7.</p>
<p>You can find the source code for Cat Encyclopedia app in this GitHub repo: <a href="https://github.com/guidemetothemoon/speaker-demos/tree/main/aks-ado-environments">cat-encyclopedia</a></p>
<p>The process is pretty straightforward and as creators state themselves, shouldn&rsquo;t require any modifications for most of the applications.
First of all we will need to update the base image in <code>Dockerfile</code> from <code>mcr.microsoft.com/dotnet/aspnet:6.0-jammy</code> to <code>mcr.microsoft.com/dotnet/nightly/aspnet:6.0-jammy-chiseled</code>. Please note that for now .NET images built with Chiseled Ubuntu Containers are available for download from nightly repos while this functionality is still in preview. Also, we must ensure that we&rsquo;re binding our container to a non-privileged port, i.e. a port that is higher than <code>1024</code>. By default Chiseled Ubuntu Containers use port <code>8080</code> so that&rsquo;s the one we will use as well.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="c1"># Dockerfile</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">FROM mcr.microsoft.com/dotnet/nightly/aspnet:6.0-jammy-chiseled
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">COPY CatEncyclopedia/src App/
</span></span><span class="line"><span class="cl">WORKDIR /App
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">ENV PORT <span class="m">8080</span>
</span></span><span class="line"><span class="cl">EXPOSE <span class="m">8080</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">ENTRYPOINT <span class="o">[</span><span class="s2">&#34;dotnet&#34;</span>, <span class="s2">&#34;CatEncyclopedia.dll&#34;</span><span class="o">]</span>
</span></span></code></pre></div><p>Now, in order to deploy the new container image to AKS, we will need to update container port in the Deployment specification and the port in the Service specification of Cat Encyclopedia Helm chart, and we&rsquo;re all set!ü§©</p>
<blockquote>
<p><em><strong>Please note that Chiseled Ubuntu Containers are supported on AKS version 1.25 or newer since it requires Ubuntu 22.04 on the Nodes as well.</strong></em></p>
</blockquote>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="c"># deployment.yaml</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c"># REST OF THE CODE IS OMITTED</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">containers</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span>{{<span class="w"> </span><span class="l">.Chart.Name }}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">securityContext</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span>{{- <span class="l">toYaml .Values.securityContext | nindent 12 }}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;{{ .Values.image.repository }}:{{ .Values.image.tag | default .Chart.AppVersion }}&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">imagePullPolicy</span><span class="p">:</span><span class="w"> </span>{{<span class="w"> </span><span class="l">.Values.image.pullPolicy }}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">ports</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">http</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">containerPort</span><span class="p">:</span><span class="w"> </span><span class="m">8080</span><span class="w"> </span><span class="c"># &lt;- Update container port on which to expose application container in a Pod</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">protocol</span><span class="p">:</span><span class="w"> </span><span class="l">TCP</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c"># REST OF THE CODE IS OMITTED</span><span class="w">
</span></span></span></code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="c"># values.yaml</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c"># REST OF THE CODE IS OMITTED</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">service</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l">ClusterIP</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">port</span><span class="p">:</span><span class="w"> </span><span class="m">8080</span><span class="w"> </span><span class="c"># &lt;- Update port of the Service that&#39;s created for Cat Encyclopedia Pods</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c"># REST OF THE CODE IS OMITTED</span><span class="w">
</span></span></span></code></pre></div><p>Finally, let&rsquo;s define Security Context for Cat Encyclopedia Pods and application container to ensure that it follows the least privilege principle:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="c"># values.yaml</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">securityContext</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">runAsUser</span><span class="p">:</span><span class="w"> </span><span class="m">999</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">runAsNonRoot</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">privileged</span><span class="p">:</span><span class="w"> </span><span class="kc">false</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">allowPrivilegeEscalation</span><span class="p">:</span><span class="w"> </span><span class="kc">false</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">capabilities</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">drop</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span>- <span class="l">all</span><span class="w">
</span></span></span></code></pre></div><p>We&rsquo;re all set! Now, once we build new container image and Helm chart, we can deploy Cat Encyclopedia to AKS and it still works as expected with Chiseled Ubuntu Containers! ü•≥</p>
<p><img src="../../images/dotnet_chiseled/cat_encyclopedia_chiseled.png" alt="Screenshot of a working ASP.NET Cat Encyclopedia application on Chiseled Ubuntu Containers"></p>
<p>If we want to upgrade it to ASP.NET 7 we will only need to update application source code to target .NET 7 and update the base image in the Dockerfile to <code>mcr.microsoft.com/dotnet/nightly/aspnet:7.0-jammy-chiseled</code>.</p>
<p>We can compare the size of the image before and after we started using Chiseled Ubuntu Containers with <code>docker images</code> command - as you can see in the screenshot below the latter is 100MB+ smaller, just as stated in the release announcementüòÅ</p>
<p><img src="../../images/dotnet_chiseled/dotnet_docker_images.png" alt="Screenshot image size comparison for ASP.NET Cat Encyclopedia application before and after Chiseled Ubuntu Containers"></p>
<p>Let&rsquo;s run a security scan for both of the images and see how many vulnerabilities will be detected in each case. For this purpose I have used a tool called <a href="https://github.com/aquasecurity/trivy">Trivy</a>. For the initial Cat Encyclopedia image which was built upon ASP.NET 6 Ubuntu Jammy base image Trivy detected 16 security vulnerabilities related to the operating system packages:</p>
<p><img src="../../images/dotnet_chiseled/dotnet_jammy_trivy.png" alt="Screenshot for Trivy security scan of the Cat Encyclopedia image built upon regular ASP.NET 6 Ubuntu Jammy base image"></p>
<p>Whilst for the updated Cat Encyclopedia image which was built upon ASP.NET 6 Chiseled Ubuntu base image Trivy detected &hellip;.</p>
<p><strong>0</strong> security vulnerabilities!üôÄ</p>
<p><img src="../../images/dotnet_chiseled/dotnet_chiseled_trivy.png" alt="Screenshot for Trivy security scan of the Cat Encyclopedia image built upon ASP.NET 6 Chiseled Ubuntu base image"></p>
<p>This is a pretty impressive result in my opinion, what do you think? üò∫</p>
<p>Finally, let&rsquo;s give it a test and try to start a shell inside a running CUC container and run some shell commands, for example, to check what packages are installed in the container - as you can see in the screenshot below, we&rsquo;re not able to do that and it makes sense since Chiseled Ubuntu Containers don&rsquo;t have any shell installed. But, we can run dotnet commands since .NET CLI is needed for the ASP.NET container and is therefore pre-installed as part of the base image.</p>
<p><img src="../../images/dotnet_chiseled/dotnet_chiseled_shell.png" alt="Screenshot where I attempt to run some shell commands towards runnign ASP.NET 6 Chiseled Ubuntu image"></p>
<p>Great job! We&rsquo;ve successfully ported an ASP.NET 6 application to Chiseled Ubuntu Containers and successfully deployed it on AKS both on ASP.NET 6 and ASP.NET 7 versions. We tested some of the improvements in terms of image size and security enhancements in Chiseled Ubuntu Containers for .NET, and it looks good under the hood! üí™ I can say that I&rsquo;m looking forward to seeing Chiseled Ubuntu Containers released in GA and adopted by more .NET applications. üòÉ</p>
<h2 id="additional-resources">Additional resources</h2>
<p>Below you may find a few resources to learn more about Chiseled Ubuntu Containers for .NET applications and securing containerized applications in general:</p>
<ul>
<li>Official announcement on .NET Blog about support for using .NET in Chiseled Ubuntu Containers starting with .NET 6: <a href="https://devblogs.microsoft.com/dotnet/dotnet-6-is-now-in-ubuntu-2204/">.NET 6 is now in Ubuntu 22.04</a></li>
<li>Great list from OWASP of common security mistakes and good practices that will help you secure your Docker containers: <a href="https://cheatsheetseries.owasp.org/cheatsheets/Docker_Security_Cheat_Sheet.html">Docker Security Cheat Sheet¬∂</a></li>
<li>GitHub repo where you can find source code for the demo app used in this blog post, including Dockerfile and Helm chart: <a href="https://github.com/guidemetothemoon/speaker-demos/tree/main/aks-ado-environments">guidemetothemoon</a></li>
<li>Official Docker documentation on enabling rootless mode: <a href="https://docs.docker.com/engine/security/rootless/">Run the Docker daemon as a non-root user (Rootless mode)</a></li>
<li>Extensive documentation about rootless containers, how it works and how it&rsquo;s supported by different components: <a href="https://rootlesscontaine.rs/getting-started/">Rootless Containers</a></li>
<li>Official documentation from Kubernetes on how to run Kubernetes Node components such as kubelet, CRI, OCI, and CNI without root privileges, by using a user namespace: <a href="https://kubernetes.io/docs/tasks/administer-cluster/kubelet-in-userns/">Running Kubernetes Node Components as a Non-root User</a></li>
</ul>
<p>That's it from me this time, thanks for checking in!üíñ</p>
<p>If this article was helpful, I'd love to hear about it! You can reach out to me on LinkedIn, Twitter, GitHub or by using the contact form on this page.üò∫</p>
<p>Stay secure, stay safe.</p>
<p>Till we connect again!üòª</p>
</div>
    <div class="post__footer">
      

      
        <span><a class="tag" href="/tags/dotnet/">dotnet</a><a class="tag" href="/tags/microservices/">microservices</a><a class="tag" href="/tags/containers/">containers</a><a class="tag" href="/tags/ubuntu/">ubuntu</a><a class="tag" href="/tags/kubernetes/">kubernetes</a></span>


      
    </div>

    
  </div>

      </main>
    </div><footer class="footer footer__base">
  <ul class="footer__list">
    <li class="footer__item">
      &copy;
      
        2023 - Powered by Hugo
      
    </li>
    
  </ul>
</footer>
  
  <script
    type="text/javascript"
    src="/js/medium-zoom.min.1248fa75275e5ef0cbef27e8c1e27dc507c445ae3a2c7d2ed0be0809555dac64.js"
    integrity="sha256-Ekj6dSdeXvDL7yfoweJ9xQfERa46LH0u0L4ICVVdrGQ="
    crossorigin="anonymous"
  ></script></body>
</html>
