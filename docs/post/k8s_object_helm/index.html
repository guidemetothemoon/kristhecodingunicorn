<!DOCTYPE html>
<html
  dir="ltr"
  lang="en"
  data-theme="dark"
  
    class="html theme--dark"
  
><head>
  <title>
    Kris - The Coding Unicorn
        |
        How to include new Kubernetes resource into existing Helm release
      

    

  </title>

  
  <meta charset="utf-8" /><meta name="generator" content="Hugo 0.109.0"><meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <meta name="author" content="Kris - The Coding Unicorn" />
  <meta
    name="description"
    content="This blog post explains how to patch an existing Helm release by including new Kubernetes resource as an example."
  />
  
    <meta name="google-site-verification" content="OQXmc6vSYyn6I-aGZoI6GH2M6CdM4NjmwulDqvvNCQA" />
  
    
    
    <link
      rel="stylesheet"
      href="/scss/main.min.5794be192d21535bdd301561e043a96b6adbad2b5c08279deff459e4661c613f.css"
      integrity="sha256-V5S&#43;GS0hU1vdMBVh4EOpa2rbrStcCCed7/RZ5GYcYT8="
      crossorigin="anonymous"
      type="text/css"
    />
  

  
  <link
    rel="stylesheet"
    href="/css/markupHighlight.min.31b0a1f317f55c529a460897848c97436bb138b19c399b37de70d463a8bf6ed5.css"
    integrity="sha256-MbCh8xf1XFKaRgiXhIyXQ2uxOLGcOZs33nDUY6i/btU="
    crossorigin="anonymous"
    type="text/css"
  />
  
    
    
    <link
      rel="stylesheet"
      href="/css/syntax.min.dd17d6ee5bba73cc3f814469aae150232f0fc13a2038e79772f4d25565b5a23c.css"
      integrity="sha256-3RfW7lu6c8w/gURpquFQIy8PwTogOOeXcvTSVWW1ojw="
      crossorigin="anonymous"
      media="screen"
    />
  
  
  <link
    rel="stylesheet"
    href="/fontawesome/css/fontawesome.min.7d272de35b410fb165377550cdf9c4d3a80fbbcc961e111914e4d5c0eaf5729f.css"
    integrity="sha256-fSct41tBD7FlN3VQzfnE06gPu8yWHhEZFOTVwOr1cp8="
    crossorigin="anonymous"
    type="text/css"
  />
  
  <link
    rel="stylesheet"
    href="/fontawesome/css/solid.min.55d8333481b07a08e07cf6f37319753a2b47e99f4c395394c5747b48b495aa9b.css"
    integrity="sha256-VdgzNIGwegjgfPbzcxl1OitH6Z9MOVOUxXR7SLSVqps="
    crossorigin="anonymous"
    type="text/css"
  />
  
  <link
    rel="stylesheet"
    href="/fontawesome/css/regular.min.a7448d02590b43449364b6b5922ed9af5410abb4de4238412a830316dedb850b.css"
    integrity="sha256-p0SNAlkLQ0STZLa1ki7Zr1QQq7TeQjhBKoMDFt7bhQs="
    crossorigin="anonymous"
    type="text/css"
  />
  
  <link
    rel="stylesheet"
    href="/fontawesome/css/brands.min.9ed75a5d670c953fe4df935937674b4646f92674367e9e66eb995bb04e821647.css"
    integrity="sha256-ntdaXWcMlT/k35NZN2dLRkb5JnQ2fp5m65lbsE6CFkc="
    crossorigin="anonymous"
    type="text/css"
  />
  
  <link rel="shortcut icon" href="/favicons/favicon.ico" type="image/x-icon" />
  <link rel="apple-touch-icon" sizes="180x180" href="/favicons/apple-touch-icon.png" />
  <link rel="icon" type="image/png" sizes="32x32" href="/favicons/favicon-32x32.png" />
  <link rel="icon" type="image/png" sizes="16x16" href="/favicons/favicon-16x16.png" />

  <link rel="canonical" href="https://kristhecodingunicorn.com/post/k8s_object_helm/" />

  
  
  
  
  <script
    type="text/javascript"
    src="/js/anatole-header.min.f9132794301a01ff16550ed66763482bd848f62243d278f5e550229a158bfd32.js"
    integrity="sha256-&#43;RMnlDAaAf8WVQ7WZ2NIK9hI9iJD0nj15VAimhWL/TI="
    crossorigin="anonymous"
  ></script>

  

  <script
  async
  defer
  src="https://umami-guidemetothemoon.vercel.app/umami.js"
  data-website-id="9dd30a0e-3918-4513-b61d-4dd81e20ed4b"
></script>



  
  <meta name="twitter:card" content="summary_large_image"/>
<meta name="twitter:image" content="https://kristhecodingunicorn.com/images/site-feature-image.png"/>

<meta name="twitter:title" content="How to include new Kubernetes resource into existing Helm release"/>
<meta name="twitter:description" content="This blog post explains how to patch an existing Helm release by including new Kubernetes resource as an example."/>



  
  <meta property="og:title" content="How to include new Kubernetes resource into existing Helm release" />
<meta property="og:description" content="This blog post explains how to patch an existing Helm release by including new Kubernetes resource as an example." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://kristhecodingunicorn.com/post/k8s_object_helm/" /><meta property="og:image" content="https://kristhecodingunicorn.com/images/site-feature-image.png"/><meta property="article:section" content="post" />
<meta property="article:published_time" content="2021-10-21T00:00:00+00:00" />
<meta property="article:modified_time" content="2021-10-21T00:00:00+00:00" /><meta property="og:site_name" content="Kris - The Coding Unicorn" />



  
  
  
  
  <script type="application/ld+json">
    {
        "@context": "http://schema.org",
        "@type": "BlogPosting",
        "articleSection": "post",
        "name": "How to include new Kubernetes resource into existing Helm release",
        "headline": "How to include new Kubernetes resource into existing Helm release",
        "alternativeHeadline": "",
        "description": "
      This blog post explains how to patch an existing Helm release by including new Kubernetes resource as an example.


    ",
        "inLanguage": "en",
        "isFamilyFriendly": "true",
        "mainEntityOfPage": {
            "@type": "WebPage",
            "@id": "https:\/\/kristhecodingunicorn.com\/post\/k8s_object_helm\/"
        },
        "author" : {
            "@type": "Person",
            "name": "Kristina D."
        },
        "creator" : {
            "@type": "Person",
            "name": "Kristina D."
        },
        "accountablePerson" : {
            "@type": "Person",
            "name": "Kristina D."
        },
        "copyrightHolder" : {
            "@type": "Person",
            "name": "Kristina D."
        },
        "copyrightYear" : "2021",
        "dateCreated": "2021-10-21T00:00:00.00Z",
        "datePublished": "2021-10-21T00:00:00.00Z",
        "dateModified": "2021-10-21T00:00:00.00Z",
        "publisher":{
            "@type":"Organization",
            "name": "Kristina D.",
            "url": "https://kristhecodingunicorn.com",
            "logo": {
                "@type": "ImageObject",
                "url": "https:\/\/kristhecodingunicorn.com\/favicons\/favicon-32x32.png",
                "width":"32",
                "height":"32"
            }
        },
        "image": 
      [
        
        "https://kristhecodingunicorn.com/images/site-feature-image.png"


      
      ]

    ,
        "url" : "https:\/\/kristhecodingunicorn.com\/post\/k8s_object_helm\/",
        "wordCount" : "1713",
        "genre" : [ ],
        "keywords" : [ 
      
      "kubernetes"

    
      
        ,

      
      "aks"

    
      
        ,

      
      "k8s"

    
      
        ,

      
      "helm"

    ]
    }
  </script>


</head>
<body class="body">
    <div class="wrapper">
      <aside
        
          class="wrapper__sidebar"
        
      ><div
  class="sidebar
    animated fadeInDown
  "
>
  <div class="sidebar__content">
    <div class="sidebar__introduction">
      <img
        class="sidebar__introduction-profileimage"
        src="/images/profile.jpg"
        alt="profile picture"
      />
      
        <div class="sidebar__introduction-title">
          <a href="/">Kris - The Coding Unicorn</a>
        </div>
      
      <div class="sidebar__introduction-description">
        <p>Hey! I'm Kris and I like to code. Welcome to my tech corner!ü§ó <br /> Azure Hero and Microsoft Azure MVP‚õÖÔ∏è | Open-Sourceressüßôüèª‚Äç‚ôÄÔ∏è | Volunteerü¶æ | <br /> Cat Mom üêàüêàüêà and Potterhead</p>
      </div>
    </div>
    <ul class="sidebar__list">
      
        <li class="sidebar__list-item">
          <a
            href="https://www.linkedin.com/in/krisde"
            target="_blank"
            rel="noopener me"
            aria-label="Linkedin"
            title="Linkedin"
          >
            <i class="fab fa-linkedin fa-2x" aria-hidden="true"></i>
          </a>
        </li>
      
        <li class="sidebar__list-item">
          <a
            href="https://github.com/guidemetothemoon"
            target="_blank"
            rel="noopener me"
            aria-label="GitHub"
            title="GitHub"
          >
            <i class="fab fa-github fa-2x" aria-hidden="true"></i>
          </a>
        </li>
      
        <li class="sidebar__list-item">
          <a
            href="https://twitter.com/kristhecodingu1"
            target="_blank"
            rel="noopener me"
            aria-label="Twitter"
            title="Twitter"
          >
            <i class="fab fa-twitter fa-2x" aria-hidden="true"></i>
          </a>
        </li>
      
        <li class="sidebar__list-item">
          <a
            href="https://sessionize.com/kristina-devochko"
            target="_blank"
            rel="noopener me"
            aria-label="Sessionize"
            title="Sessionize"
          >
            <i class="fas fa-bullhorn fa-2x" aria-hidden="true"></i>
          </a>
        </li>
      
        <li class="sidebar__list-item">
          <a
            href="https://www.instagram.com/guidemetothemoon"
            target="_blank"
            rel="noopener me"
            aria-label="instagram"
            title="instagram"
          >
            <i class="fab fa-instagram fa-2x" aria-hidden="true"></i>
          </a>
        </li>
      
        <li class="sidebar__list-item">
          <a
            href="/contact/"
            target="_blank"
            rel="noopener me"
            aria-label="e-mail"
            title="e-mail"
          >
            <i class="fas fa-envelope fa-2x" aria-hidden="true"></i>
          </a>
        </li>
      
        <li class="sidebar__list-item">
          <a
            href="https://feedly.com/i/subscription/feed%2Fhttps%3A%2F%2Fkristhecodingunicorn.com%2Findex.xml"
            target="_blank"
            rel="noopener me"
            aria-label="rss"
            title="rss"
          >
            <i class="fas fa-rss fa-2x" aria-hidden="true"></i>
          </a>
        </li>
      
        <li class="sidebar__list-item">
          <a
            href="https://www.azureheroes.community/user/15391"
            target="_blank"
            rel="noopener me"
            aria-label="Azure Heroes"
            title="Azure Heroes"
          >
            <i class="fas fa-mask fa-2x" aria-hidden="true"></i>
          </a>
        </li>
      
        <li class="sidebar__list-item">
          <a
            href="https://mvp.microsoft.com/en-us/PublicProfile/5004929?fullName=Kristina%20Devochko"
            target="_blank"
            rel="noopener me"
            aria-label="Microsoft MVP"
            title="Microsoft MVP"
          >
            <i class="fas fa-cloud fa-2x" aria-hidden="true"></i>
          </a>
        </li>
      
    </ul>
  </div><footer class="footer footer__sidebar">
  <ul class="footer__list">
    <li class="footer__item">
      &copy;
      
        2023 - Powered by Hugo
      
    </li>
    
  </ul>
</footer>
  
  <script
    type="text/javascript"
    src="/js/medium-zoom.min.1248fa75275e5ef0cbef27e8c1e27dc507c445ae3a2c7d2ed0be0809555dac64.js"
    integrity="sha256-Ekj6dSdeXvDL7yfoweJ9xQfERa46LH0u0L4ICVVdrGQ="
    crossorigin="anonymous"
  ></script></div>
</aside>
      <main
        
          class="wrapper__main"
        
      >
        <header class="header"><div
  class="
    animated fadeInDown
  "
>
  <a role="button" class="navbar-burger" data-target="navMenu" aria-label="menu" aria-expanded="false">
    <span aria-hidden="true" class="navbar-burger__line"></span>
    <span aria-hidden="true" class="navbar-burger__line"></span>
    <span aria-hidden="true" class="navbar-burger__line"></span>
  </a>
  <nav class="nav">
    <ul class="nav__list" id="navMenu">
      
      
        
        
          <li class="nav__list-item">
            <a
              
              href="/"
              
              title=""
              >Home</a
            >
          </li>
        

      
        
        
          <li class="nav__list-item">
            <a
              
              href="/post/"
              
              title=""
              >Blog</a
            >
          </li>
        

      
        
        
          <li class="nav__list-item">
            <a
              
              href="/techtips/"
              
              title=""
              >Tech Tips</a
            >
          </li>
        

      
        
        
          <li class="nav__list-item">
            <a
              
              href="/public/"
              
              title=""
              >Public Talks and Publications</a
            >
          </li>
        

      
        
        
          <li class="nav__list-item">
            <a
              
              href="/about/"
              
              title=""
              >About</a
            >
          </li>
        

      
        
        
          <li class="nav__list-item">
            <a
              
              href="/contact/"
              
              title=""
              >Contact</a
            >
          </li>
        

      
    </ul>
    <ul class="nav__list nav__list--end">
      
      
    </ul>
  </nav>
</div>
</header>
  <div
    class="post 
      animated fadeInDown
    "
  >
    
    <div class="post__content">
      <h1>How to Include New Kubernetes Resource Into Existing Helm Release</h1>
      
        <ul class="post__meta">
          <li class="post__meta-item">
            <em class="fas fa-calendar-day post__meta-icon"></em>
            <span class="post__meta-text"
              >
                
                  21/10/2021
                

              
            </span>
          </li>
          <li class="post__meta-item">
            <em class="fas fa-stopwatch post__meta-icon"></em>
            <span class="post__meta-text">9-minute read</span>
          </li>
        </ul>
      <p><img src="../../images/k8s_object_helm/k8s_object_helm_banner.png" alt="Article banner for adding Kubernetes resource to Helm release"></p>
<div class="toc">
  <nav id="TableOfContents">
  <ul>
    <li><a href="#what-is-helm">What is Helm?</a></li>
    <li><a href="#how-to-let-existing-helm-release-adopt-a-new-kubernetes-resource-and-why-its-important">How to let existing Helm release &ldquo;adopt&rdquo; a new Kubernetes resource and why it's important?</a></li>
    <li><a href="#additional-resources">Additional resources</a></li>
  </ul>
</nav>
</div>
<p>Helm is extremely useful and efficient when it comes to distributing, installing and upgrading applications hosted in Kubernetes. But sometimes you may have a need to patch an existing release and there is a quick way to do that which I would like to share with you today.
A scenario I had to face was that I discovered missing PodDisruptionBudget on one of the production deployments and after this has been fixed in the source code I had therefore a need to add it to the existing Helm release to ensure configuration consistency.</p>
<blockquote>
<p><strong>PodDisruptionBudget (PDB)</strong> is a very neat Kubernetes feature which makes your application highly available, especially in case of planned cluster disruptions. PDB defines the number of application Pods that can be unavailable at the same time in case of voluntary disruptions. An important point to note here is that <strong>the number of Pods that you define as available/unavailable for PDB must be lower than the total count of Pods you have defined to be deployed</strong>. You can read more about PDBs here: <a href="https://kubernetes.io/docs/concepts/workloads/pods/disruptions/#pod-disruption-budgets">Disruptions</a></p>
</blockquote>
<p>There are multiple ways to solve this: I could've created and published a new version of the Helm chart or I could've re-built and re-uploaded an existing Helm chart but I didn't want to mess with the original version of the Helm chart so I've decided to go for another solution where I've created a script to automatically apply the PDB to all the relevant Kubernetes deployments and let Helm, that the Kubernetes deployments were created with, &quot;adopt&quot; PDB with help of just a few annotations and labels.</p>
<p>But first things first. Let's freshen up some basics.</p>
<h2 id="what-is-helm">What is Helm?</h2>
<p>Helm is basically a package manager for Kubernetes - it helps you describe, install and upgrade applications hosted in Kubernetes in an easy and unified way with help of Helm Charts. Helm is a CNCF project and is open-source, maintained by the Helm community on GitHub: <a href="https://github.com/helm/community">Helm community</a>. By using Helm you can deploy a single application in the same way to different environments - development, staging, production, you name it. The only thing you will need to do is to have a separate set of values (<code>values-\[dev/staging/prod\].yaml</code> per environment) where you can define resource allocation depending on what environment the application will be deployed to. The rest of the application definition will be generic and applicable to any deployment environment. Using tools like Helm will minimize probability of human errors and be a great addition to your Kubernetes deployment automation.</p>
<p>Want to know more? Take a look at the official Helm documentation: <a href="https://helm.sh/docs/">Helm Docs</a></p>
<p>Now, let's say that we have deployed a specific version of our test application to production with Helm and realized that we're missing PodDisruptionBudget - we've already fixed this in the source code but how can we patch this to an existing Helm deployment?</p>
<blockquote>
<p>Approach described below is applicable for Helm 3, not the earlier version.</p>
</blockquote>
<h2 id="how-to-let-existing-helm-release-adopt-a-new-kubernetes-resource-and-why-its-important">How to let existing Helm release &ldquo;adopt&rdquo; a new Kubernetes resource and why it's important?</h2>
<p>First of all, why would you bother making sure that the Kubernetes resource you're patching the existing deployment with is accounted for by Helm? Well, you could of course just patch your Helm deployment as any regular Kubernetes deployment with <code>kubectl patch</code> or <code>kubectl apply</code> and not bother about Helm specifics at all, but this approach has it's unpleasant consequences:</p>
<ul>
<li>If you decide at some point to delete this specific Helm deployment, it will not clean up the resources you have created with <code>kubectl patch</code> or <code>kubectl apply</code> which means that you will need to know what resources you have patched manually during lifetime of the deployment and clean those up yourself.</li>
<li>If you have made changes to the Object definition in the source code and then at some point upgrade the patched deployment where the same Object was patched with <code>kubectl patch</code> or <code>kubectl apply</code>, you may risk getting an error like this:</li>
</ul>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-txt" data-lang="txt"><span class="line"><span class="cl">  Error: rendered manifests contain a resource that already exists. 
</span></span><span class="line"><span class="cl">  Unable to continue with install: PodDisruptionBudget &#34;mytestapp-pdb&#34; in namespace &#34;mytestapp&#34; exists and cannot be imported into the current release: invalid ownership metadata; 
</span></span><span class="line"><span class="cl">  label validation error: missing key &#34;app.kubernetes.io/managed-by&#34;: must be set to &#34;Helm&#34;; 
</span></span><span class="line"><span class="cl">  annotation validation error: missing key &#34;meta.helm.sh/release-name&#34;: must be set to &#34;mytestapp-10&#34;; 
</span></span><span class="line"><span class="cl">  annotation validation error: missing key &#34;meta.helm.sh/release-namespace&#34;: must be set to &#34;mytestapp&#34;</span></span></code></pre></div>
<p>The error above is pretty much self-explanatory and can be fixed by either deleting the existing resource and re-trying upgrade, or re-patching the existing resource with proper annotations and labels so that it can be registered and managed by Helm - for guidance on how to do that, see more below ;-)</p>
<p>In Helm 3 it's quite easy to include a new Kubernetes Object into the Helm release - you can do that by adding following annotations to the Object definition:</p>
<ul>
<li><code>meta.helm.sh/release-name: [name_of_your_Helm_release]</code> -&gt; name of the Helm release, typically the name you define for the application deployment</li>
<li><code>meta.helm.sh/release-namespace: [namespace_of_your_Helm_release]</code> -&gt; this one's important in case you're using namespaces in your Kubernetes clusters. If not provided, default namespace will be used</li>
</ul>
<p>You will also need to add following label to the Object definition:</p>
<ul>
<li><code>app.kubernetes.io/managed-by: Helm</code> -&gt; this label lets Helm know that you would like to include current Kubernetes Object into Helm release you're patching</li>
</ul>
<p>I'll continue illustrating the concept with PDB example. So, knowing about the annotations and labels I need to add to the PDB definition, I've created following definition file - here I'm using placeholders because I would like to show you how patching can be automated for multiple deployments:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="c"># pdb.yaml</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">policy/v1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">PodDisruptionBudget</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="l">deployment_name]-pdb</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="l">deployment_namespace]</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">annotations</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">meta.helm.sh/release-name</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="l">deployment_name]</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">meta.helm.sh/release-namespace</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="l">deployment_namespace]</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">labels</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">app.kubernetes.io/managed-by</span><span class="p">:</span><span class="w"> </span><span class="l">Helm</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">minAvailable</span><span class="p">:</span><span class="w"> </span><span class="m">50</span><span class="l">%</span><span class="w"> </span><span class="c"># This value defines that I want half of the Pods to be available at all times in case of disruptions. For odd counts, like 7, this value will result in 4 Pods always being available</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">selector</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">matchLabels</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">[</span><span class="l">deployment_labels]</span></span></span></code></pre></div>
<p>And we're all set! Now our PDB is ready to be patched to the existing application deployment running in production as well as managed by Helm going forward! But what if we have tens, hundreds or even thousands of application deployments that we need to patch this to? Do we need to create this Object manually for every single deployment?? Not to worry, we can automate it!</p>
<p>I've created following script that will get all the deployments I would like to patch based on the filter I provide and replace the placeholders in the pdb.yaml file we've created above with values related to every individual deployment we're patching. Then it will create a new version of the file (which is also useful in case we want to check the content before creating the new resource) for every deployment and finally apply it in order to create the resource we want - in this case, a PodDisruptionBudget.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-powershell" data-lang="powershell"><span class="line"><span class="cl"><span class="c"># Add-PDB.ps1</span>
</span></span><span class="line"><span class="cl"><span class="c"># OBS! Ensure that you&#39;re connected to the correct Kubernetes cluster BEFORE executing the script</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c"># This filter can be adjusted to filter only the deployments you want to apply PodDisruptionBudget to. Current filter is for the deployments of mytestapp only</span>
</span></span><span class="line"><span class="cl"><span class="nv">$deployments</span><span class="p">=((</span><span class="n">kubectl</span> <span class="n">get</span> <span class="n">deployments</span><span class="p">.</span><span class="py">apps</span> <span class="n">-A</span> <span class="n">-o</span> <span class="n">json</span> <span class="p">|</span> <span class="nb">ConvertFrom-Json</span><span class="p">).</span><span class="n">items</span><span class="p">)</span> <span class="p">|</span> <span class="nb">Where-Object</span> <span class="p">{</span><span class="nv">$_</span><span class="p">.</span><span class="py">metadata</span><span class="p">.</span><span class="py">name</span> <span class="o">-match</span> <span class="s1">&#39;mytestapp&#39;</span><span class="p">};</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">foreach</span><span class="p">(</span><span class="nv">$deploy</span> <span class="k">in</span> <span class="nv">$deployments</span><span class="p">){</span>
</span></span><span class="line"><span class="cl">  <span class="c"># 1. For each deployment, get raw content of yaml file and deployment values to update the yaml with</span>
</span></span><span class="line"><span class="cl">  <span class="nv">$pdb_yaml</span> <span class="p">=</span> <span class="nb">Get-Content</span> <span class="nv">$PSScriptRoot</span><span class="p">/</span><span class="n">pdb</span><span class="p">.</span><span class="py">yaml</span> <span class="n">-Raw</span>
</span></span><span class="line"><span class="cl">  <span class="nv">$deploy_name</span> <span class="p">=</span> <span class="nv">$deploy</span><span class="p">.</span><span class="py">metadata</span><span class="p">.</span><span class="py">name</span>
</span></span><span class="line"><span class="cl">  <span class="nv">$deploy_ns</span> <span class="p">=</span> <span class="nv">$deploy</span><span class="p">.</span><span class="py">metadata</span><span class="p">.</span><span class="py">namespace</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="nv">$labels</span> <span class="p">=</span> <span class="nv">$deploy</span><span class="p">.</span><span class="py">spec</span><span class="p">.</span><span class="py">selector</span><span class="p">.</span><span class="py">matchLabels</span> 
</span></span><span class="line"><span class="cl">  <span class="nv">$label_props</span> <span class="p">=</span> <span class="nv">$labels</span> <span class="p">|</span> <span class="nb">get-member</span> <span class="n">-MemberType</span> <span class="n">NoteProperty</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="nv">$formatted_labels</span> <span class="p">=</span> <span class="s2">&#34;&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="c"># 2. There may be multiple selectorLabels so we need to ensure that those are formatted according to the YAML formatting laws</span>
</span></span><span class="line"><span class="cl">  <span class="k">foreach</span><span class="p">(</span><span class="nv">$labelName</span> <span class="k">in</span> <span class="nv">$label_props</span><span class="p">.</span><span class="n">Name</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c"># Due to YAML strictness on formatting we&#39;ll use this hack to format multiple selector labels in the allowed way</span>
</span></span><span class="line"><span class="cl">    <span class="nv">$formatted_labels</span> <span class="p">+=</span> <span class="s2">&#34;      </span><span class="p">$(</span><span class="nv">$labelName</span><span class="p">)</span><span class="s2">: </span><span class="p">$(</span><span class="nv">$labels</span><span class="p">.</span><span class="nv">$labelName</span><span class="p">)</span><span class="se">`n</span><span class="s2">&#34;</span>    
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="c"># 3. Replace placeholders in YAML-file with mytestapp deployment values</span>
</span></span><span class="line"><span class="cl">  <span class="nv">$pdb_yaml</span> <span class="p">=</span> <span class="nv">$pdb_yaml</span><span class="p">.</span><span class="py">Replace</span><span class="p">(</span><span class="s1">&#39;[deployment_name]&#39;</span><span class="p">,</span><span class="nv">$deploy_name</span><span class="p">).</span><span class="py">Replace</span><span class="p">(</span><span class="s1">&#39;[deployment_namespace]&#39;</span><span class="p">,</span><span class="nv">$deploy_ns</span><span class="p">).</span><span class="py">Replace</span><span class="p">(</span><span class="s1">&#39;[deployment_labels]&#39;</span><span class="p">,</span><span class="nv">$formatted_labels</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="nv">$pdb_yaml</span> <span class="p">|</span> <span class="nb">Out-File</span> <span class="n">-FilePath</span> <span class="s2">&#34;</span><span class="nv">$PSScriptRoot</span><span class="s2">/pdb-</span><span class="p">$(</span><span class="nv">$deploy_name</span><span class="p">)</span><span class="s2">.yaml&#34;</span> <span class="n">-Encoding</span> <span class="n">utf8</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="c"># 4. Apply updated YAML-file to add PodDisruptionBudget for current deployment</span>
</span></span><span class="line"><span class="cl">  <span class="nb">Write-Output</span> <span class="s2">&#34;Applying PDB deployment pdb-</span><span class="p">$(</span><span class="nv">$deploy_name</span><span class="p">)</span><span class="s2">.yaml for deployment </span><span class="nv">$deploy_name</span><span class="s2">&#34;</span>
</span></span><span class="line"><span class="cl">  <span class="n">kubectl</span> <span class="n">apply</span> <span class="o">-f</span> <span class="s2">&#34;</span><span class="nv">$PSScriptRoot</span><span class="s2">/pdb-</span><span class="p">$(</span><span class="nv">$deploy_name</span><span class="p">)</span><span class="s2">.yaml&#34;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span></span></span></code></pre></div>
<p>Now, if I execute this script on my Kubernetes cluster, it'll create PDB for every deployment of <strong>mytestapp</strong> which I've used as a filter in the first line of the script above. And PDB will be included into every Helm release that <strong>mytestapp</strong> deployments have been created with so if I decide to delete one of the deployments with <strong>helm uninstall</strong>, the respective PDB will be removed as well, thanks to the annotations and labels we've provided in the PDB definition file.</p>
<p>If you would like to see PDB in action, you can simulate a disruption by draining one of the nodes that your application's Pod is running on with following kubectl command:</p>
<p><code>kubectl drain --delete-emptydir-data --force --ignore-daemonsets &lt;your_node_name&gt;</code></p>
<p>After executing the command above you should be able to see messages in the console output saying that a Pod can&rsquo;t be deleted due to potential violation of PodDisruptionBudget Policy. Once a new Pod is scheduled and ready on another node, this alert will disappear and the Pod on the to-be-drained-node will be evicted. You can read more about node draining procedure here: <a href="https://kubernetes.io/docs/tasks/administer-cluster/safely-drain-node/">Safely drain a Node</a></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-txt" data-lang="txt"><span class="line"><span class="cl">PS C:\&gt; Set-Alias -Name k -Value kubectl
</span></span><span class="line"><span class="cl">PS C:\&gt; k drain --delete-emptydir-data --force --ignore-daemonsets aks-nodepool1-14745837-vmss000001
</span></span><span class="line"><span class="cl">node/aks-nodepool1-14745837-vmss000001 cordoned
</span></span><span class="line"><span class="cl">evicting pod mytestapp/app-1
</span></span><span class="line"><span class="cl">evicting pod mytestapp/app-2
</span></span><span class="line"><span class="cl">error when evicting pods/&#34;app-2&#34; -n &#34;mytestapp&#34; (will retry after 5s): Cannot evict pod as it would violate the pod&#39;s disruption budget.
</span></span><span class="line"><span class="cl">pod/app-2 evicted
</span></span><span class="line"><span class="cl">node/aks-nodepool1-14745837-vmss000001 evicted</span></span></code></pre></div>
<h2 id="additional-resources">Additional resources</h2>
<p>Some information I find useful and relevant when working with Kubernetes deployments and Helm:</p>
<ul>
<li>Official Helm Docs provide good explanation of main concepts and definitions like Helm Charts and Helm Release here: <a href="https://helm.sh/docs/intro/using_helm/">Using Helm</a></li>
<li>I've also mentioned some kubectl commands that I didn't go into much details about but if you're not familiar with those, you can read more about the differences between those in this article: <a href="https://kubernetes.io/docs/concepts/cluster-administration/manage-deployment/#in-place-updates-of-resources">In-place updates of resources</a></li>
</ul>
<p>That's it from me this time, thanks for checking in!
If this article was helpful, I'd love to hear about it! You can reach out to me on LinkedIn, GitHub or by using the contact form on this page :)</p>
<p>Stay secure, stay safe.</p>
<p>Till we connect again!</p>
</div>
    <div class="post__footer">
      

      
        <span><a class="tag" href="/tags/kubernetes/">kubernetes</a><a class="tag" href="/tags/aks/">aks</a><a class="tag" href="/tags/k8s/">k8s</a><a class="tag" href="/tags/helm/">helm</a></span>


      
    </div>

    
  </div>

      </main>
    </div><footer class="footer footer__base">
  <ul class="footer__list">
    <li class="footer__item">
      &copy;
      
        2023 - Powered by Hugo
      
    </li>
    
  </ul>
</footer>
  
  <script
    type="text/javascript"
    src="/js/medium-zoom.min.1248fa75275e5ef0cbef27e8c1e27dc507c445ae3a2c7d2ed0be0809555dac64.js"
    integrity="sha256-Ekj6dSdeXvDL7yfoweJ9xQfERa46LH0u0L4ICVVdrGQ="
    crossorigin="anonymous"
  ></script></body>
</html>
