<!DOCTYPE html>
<html
  dir="ltr"
  lang="en"
  data-theme="dark"
  
    class="html theme--dark"
  
><head>
  <title>
    Kris - The Coding Unicorn
        |
        Monitoring Kubernetes API deprecations with Pluto
      

    

  </title>

  
  <meta charset="utf-8" /><meta name="generator" content="Hugo 0.118.2"><meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <meta name="author" content="Kris - The Coding Unicorn" />
  <meta
    name="description"
    content="In this blog post we&#39;ll look into how you can monitor Kubernetes API deprecations and automate it in CI/CD with Pluto."
  />
  
    <meta name="google-site-verification" content="OQXmc6vSYyn6I-aGZoI6GH2M6CdM4NjmwulDqvvNCQA" />
  
    
    
    <link
      rel="stylesheet"
      href="/scss/main.min.772eefee9824c26da5d3828c2507ea318c8e7a37b0b1d18cd4f224edc2755fea.css"
      integrity="sha256-dy7v7pgkwm2l04KMJQfqMYyOejewsdGM1PIk7cJ1X&#43;o="
      crossorigin="anonymous"
      type="text/css"
    />
  

  
  <link
    rel="stylesheet"
    href="/css/markupHighlight.min.73ccfdf28df555e11009c13c20ced067af3cb021504cba43644c705930428b00.css"
    integrity="sha256-c8z98o31VeEQCcE8IM7QZ688sCFQTLpDZExwWTBCiwA="
    crossorigin="anonymous"
    type="text/css"
  />
  
    
    
    <link
      rel="stylesheet"
      href="/css/syntax.min.dd17d6ee5bba73cc3f814469aae150232f0fc13a2038e79772f4d25565b5a23c.css"
      integrity="sha256-3RfW7lu6c8w/gURpquFQIy8PwTogOOeXcvTSVWW1ojw="
      crossorigin="anonymous"
      media="screen"
    />
  
  
  <link
    rel="stylesheet"
    href="/fontawesome/css/fontawesome.min.7d272de35b410fb165377550cdf9c4d3a80fbbcc961e111914e4d5c0eaf5729f.css"
    integrity="sha256-fSct41tBD7FlN3VQzfnE06gPu8yWHhEZFOTVwOr1cp8="
    crossorigin="anonymous"
    type="text/css"
  />
  
  <link
    rel="stylesheet"
    href="/fontawesome/css/solid.min.55d8333481b07a08e07cf6f37319753a2b47e99f4c395394c5747b48b495aa9b.css"
    integrity="sha256-VdgzNIGwegjgfPbzcxl1OitH6Z9MOVOUxXR7SLSVqps="
    crossorigin="anonymous"
    type="text/css"
  />
  
  <link
    rel="stylesheet"
    href="/fontawesome/css/regular.min.a7448d02590b43449364b6b5922ed9af5410abb4de4238412a830316dedb850b.css"
    integrity="sha256-p0SNAlkLQ0STZLa1ki7Zr1QQq7TeQjhBKoMDFt7bhQs="
    crossorigin="anonymous"
    type="text/css"
  />
  
  <link
    rel="stylesheet"
    href="/fontawesome/css/brands.min.9ed75a5d670c953fe4df935937674b4646f92674367e9e66eb995bb04e821647.css"
    integrity="sha256-ntdaXWcMlT/k35NZN2dLRkb5JnQ2fp5m65lbsE6CFkc="
    crossorigin="anonymous"
    type="text/css"
  />
  
  <link rel="shortcut icon" href="/favicons/favicon.ico" type="image/x-icon" />
  <link rel="apple-touch-icon" sizes="180x180" href="/favicons/apple-touch-icon.png" />
  <link rel="icon" type="image/png" sizes="32x32" href="/favicons/favicon-32x32.png" />
  <link rel="icon" type="image/png" sizes="16x16" href="/favicons/favicon-16x16.png" />

  <link rel="canonical" href="https://kristhecodingunicorn.com/post/k8s_pluto/" />

  
  
  
  
  <script
    type="text/javascript"
    src="/js/anatole-header.min.f9132794301a01ff16550ed66763482bd848f62243d278f5e550229a158bfd32.js"
    integrity="sha256-&#43;RMnlDAaAf8WVQ7WZ2NIK9hI9iJD0nj15VAimhWL/TI="
    crossorigin="anonymous"
  ></script>

  

  <script
  async
  defer
  src="https://umami-guidemetothemoon.vercel.app/18352c56e4b049f69a24fbae0ca62b4f.js"
  data-website-id="9dd30a0e-3918-4513-b61d-4dd81e20ed4b"
></script>



  
  <meta name="twitter:card" content="summary_large_image"/>
<meta name="twitter:image" content="https://kristhecodingunicorn.com/images/site-feature-image.png"/>

<meta name="twitter:title" content="Monitoring Kubernetes API deprecations with Pluto"/>
<meta name="twitter:description" content="In this blog post we&#39;ll look into how you can monitor Kubernetes API deprecations and automate it in CI/CD with Pluto."/>



  
  <meta property="og:title" content="Monitoring Kubernetes API deprecations with Pluto" />
<meta property="og:description" content="In this blog post we&#39;ll look into how you can monitor Kubernetes API deprecations and automate it in CI/CD with Pluto." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://kristhecodingunicorn.com/post/k8s_pluto/" /><meta property="og:image" content="https://kristhecodingunicorn.com/images/site-feature-image.png"/><meta property="article:section" content="post" />
<meta property="article:published_time" content="2022-08-14T00:00:00+00:00" />
<meta property="article:modified_time" content="2022-08-14T00:00:00+00:00" /><meta property="og:site_name" content="Kris - The Coding Unicorn" />



  
  
  
  
  <script type="application/ld+json">
    {
        "@context": "http://schema.org",
        "@type": "BlogPosting",
        "articleSection": "post",
        "name": "Monitoring Kubernetes API deprecations with Pluto",
        "headline": "Monitoring Kubernetes API deprecations with Pluto",
        "alternativeHeadline": "",
        "description": "
      In this blog post we\u0027ll look into how you can monitor Kubernetes API deprecations and automate it in CI\/CD with Pluto.


    ",
        "inLanguage": "en",
        "isFamilyFriendly": "true",
        "mainEntityOfPage": {
            "@type": "WebPage",
            "@id": "https:\/\/kristhecodingunicorn.com\/post\/k8s_pluto\/"
        },
        "author" : {
            "@type": "Person",
            "name": "Kristina D."
        },
        "creator" : {
            "@type": "Person",
            "name": "Kristina D."
        },
        "accountablePerson" : {
            "@type": "Person",
            "name": "Kristina D."
        },
        "copyrightHolder" : {
            "@type": "Person",
            "name": "Kristina D."
        },
        "copyrightYear" : "2022",
        "dateCreated": "2022-08-14T00:00:00.00Z",
        "datePublished": "2022-08-14T00:00:00.00Z",
        "dateModified": "2022-08-14T00:00:00.00Z",
        "publisher":{
            "@type":"Organization",
            "name": "Kristina D.",
            "url": "https://kristhecodingunicorn.com",
            "logo": {
                "@type": "ImageObject",
                "url": "https:\/\/kristhecodingunicorn.com\/favicons\/favicon-32x32.png",
                "width":"32",
                "height":"32"
            }
        },
        "image": 
      [
        
        "https://kristhecodingunicorn.com/images/site-feature-image.png"


      
      ]

    ,
        "url" : "https:\/\/kristhecodingunicorn.com\/post\/k8s_pluto\/",
        "wordCount" : "2289",
        "genre" : [ ],
        "keywords" : [ 
      
      "kubernetes"

    
      
        ,

      
      "aks"

    
      
        ,

      
      "k8s"

    
      
        ,

      
      "azure"

    
      
        ,

      
      "devops"

    ]
    }
  </script>


</head>
<body class="body">
    <div class="wrapper">
      <aside
        
          class="wrapper__sidebar"
        
      ><div
  class="sidebar
    animated fadeInDown
  "
>
  <div class="sidebar__content">
    <div class="sidebar__introduction">
      <img
        class="sidebar__introduction-profileimage"
        src="/images/profile.webp"
        alt="profile picture"
      />
      
        <div class="sidebar__introduction-title">
          <a href="/">Kris - The Coding Unicorn</a>
        </div>
      
      <div class="sidebar__introduction-description">
        <p>Welcome to my tech corner! ü§ó <br />I preach about all things cloud native, green tech and cats üêà <br />Check "Blog" for new posts and "About" for my community involvement ü¶Ñ</p>
      </div>
    </div>
    <ul class="sidebar__list">
      
        <li class="sidebar__list-item">
          <a
            href="https://linkfree.io/guidemetothemoon"
            target="_blank"
            rel="noopener me"
            aria-label="Let&#39;s connect!"
            title="Let&#39;s connect!"
          >
            <i class="fas fa-cat fa-2x" aria-hidden="true"></i>
          </a>
        </li>
      
        <li class="sidebar__list-item">
          <a
            href="https://www.buymeacoffee.com/kristhecodingu1"
            target="_blank"
            rel="noopener me"
            aria-label="Help me buy supplies for homeless animals &lt;3"
            title="Help me buy supplies for homeless animals &lt;3"
          >
            <i class="fas fa-hand-holding-heart fa-2x" aria-hidden="true"></i>
          </a>
        </li>
      
        <li class="sidebar__list-item">
          <a
            href="https://feedly.com/i/subscription/feed%2Fhttps%3A%2F%2Fkristhecodingunicorn.com%2Findex.xml"
            target="_blank"
            rel="noopener me"
            aria-label="RSS feed"
            title="RSS feed"
          >
            <i class="fas fa-rss fa-2x" aria-hidden="true"></i>
          </a>
        </li>
      
    </ul>
  </div>
  
    <div id="wcb"  
        
        class="carbonbadge wcb-d"
        
    >
    </div>
    <script src="https://unpkg.com/website-carbon-badges@1.1.3/b.min.js" defer></script>
  <footer class="footer footer__sidebar">
  <ul class="footer__list">
    <li class="footer__item">
      &copy;
      
        2023 - Powered by Hugo
      
    </li>
    
  </ul>
</footer>
  
  <script
    type="text/javascript"
    src="/js/medium-zoom.min.1248fa75275e5ef0cbef27e8c1e27dc507c445ae3a2c7d2ed0be0809555dac64.js"
    integrity="sha256-Ekj6dSdeXvDL7yfoweJ9xQfERa46LH0u0L4ICVVdrGQ="
    crossorigin="anonymous"
  ></script></div>
</aside>
      <main
        
          class="wrapper__main"
        
      >
        <header class="header"><div
  class="
    animated fadeInDown
  "
>
  <a role="button" class="navbar-burger" data-target="navMenu" aria-label="menu" aria-expanded="false">
    <span aria-hidden="true" class="navbar-burger__line"></span>
    <span aria-hidden="true" class="navbar-burger__line"></span>
    <span aria-hidden="true" class="navbar-burger__line"></span>
  </a>
  <nav class="nav">
    <ul class="nav__list" id="navMenu">
      
      
        
        
          <li class="nav__list-item">
            
            <a
              
              href="/"
              
              title=""
              >Home</a
            >
          </li>
        

      
        
        
          <li class="nav__list-item">
            
            <a
              
              href="/post/"
              
              title=""
              >Blog</a
            >
          </li>
        

      
        
        
          <li class="nav__list-item">
            
            <a
              
              href="/techtips/"
              
              title=""
              >Tech Tips</a
            >
          </li>
        

      
        
        
          <li class="nav__list-item">
            
            <a
              
              href="/public/"
              
              title=""
              >Public Talks and Publications</a
            >
          </li>
        

      
        
        
          <li class="nav__list-item">
            
            <a
              
              href="/about/"
              
              title=""
              >About</a
            >
          </li>
        

      
        
        
          <li class="nav__list-item">
            
            <a
              
              href="/contact/"
              
              title=""
              >Contact</a
            >
          </li>
        

      
    </ul>
    <ul class="nav__list nav__list--end">
      
      
    </ul>
  </nav>
</div>
</header>
  <div
    class="post 
      animated fadeInDown
    "
  >
    
    <div class="post__content">
      <h1>Monitoring Kubernetes API Deprecations With Pluto</h1>
      
        <ul class="post__meta">
          <li class="post__meta-item">
            <em class="fas fa-calendar-day post__meta-icon"></em>
            <span class="post__meta-text"
              >
                
                  14/8/2022
                

              
            </span>
          </li>
          <li class="post__meta-item">
            <em class="fas fa-stopwatch post__meta-icon"></em>
            <span class="post__meta-text">11-minute read</span>
          </li>
        </ul>
      <div class="toc">
  <nav id="TableOfContents">
  <ul>
    <li><a href="#what-is-pluto">What is Pluto?</a></li>
    <li><a href="#installing-and-running-pluto">Installing and Running Pluto</a>
      <ul>
        <li><a href="#in-cluster-helm-chart-scanning">In-cluster Helm Chart scanning</a></li>
        <li><a href="#cicd---azure-devops">CI/CD -&gt; Azure DevOps</a></li>
        <li><a href="#cicd---github-actions">CI/CD -&gt; GitHub Actions</a></li>
        <li><a href="#local-files">Local files</a></li>
      </ul>
    </li>
    <li><a href="#alternative-tools">Alternative tools</a></li>
    <li><a href="#additional-resources">Additional resources</a></li>
  </ul>
</nav>
</div>
<p>If you've worked with Kubernetes for a while you should have seen that version lifecycle that Kubernetes has is pretty aggressive. Kubernetes is being actively developed which means that new releases come out pretty frequently - and all of us who are using Kubernetes, be it a managed or a self-hosted distribution, must adapt and adjust. If not, we may risk running our workloads on unsupported version of Kubernetes with lacking security and functionality fixes. In addition, when the time comes to upgrade there's a big risk that the change gap will be too large from the Kubernetes version you're running and the one you want to upgrade to - this normally ends up in a complicated and unstable upgrade process which I wouldn't recommend to anyone, especially in a production environment&hellip;üòë</p>
<p>What makes Kubernetes releases a bit challenging is that every release normally has deprecated and removed APIs - some releases more than others. These breaking changes require us as Kubernetes operators to update our workloads and migrate from deprecated/removed APIs before upgrading the cluster. If you have multiple workloads running in Kubernetes clusters, continuously monitoring deprecations can get challenging and time-consuming. Especially if you need to ask developers to update deployment templates for the applications they own.</p>
<p>But there are tools that may help you get a better overview of resources that you need to update and even block upcoming deployment until respective resources are updated.</p>
<p>In this blog post I would like to take a look at an open source tool called Pluto and how it can be used to monitor Kubernetes APIs deprecations.üò∫</p>
<h2 id="what-is-pluto">What is Pluto?</h2>
<p><img src="../../images/k8s_pluto/pluto_logo.png" alt="Pluto Logo"></p>
<p>Pluto is an open source tool developed by Fairwinds that helps detect deprecated Kubernetes API versions both in:</p>
<ul>
<li>static manifests like Kubernetes YAML templates and Helm charts and</li>
<li>live in Kubernetes clusters (Helm charts only).</li>
</ul>
<p>You can run Pluto locally as well as integrate as part of your CI/CD pipeline. From what I've seen so far, the tool is quite actively developed and maintained and keeps up well with official Kubernetes releases and API deprecations/removals.</p>
<p>You can find official documentation for Pluto here: <a href="https://pluto.docs.fairwinds.com/#purpose">Pluto</a></p>
<h2 id="installing-and-running-pluto">Installing and Running Pluto</h2>
<p>You can find all the code provided in this section in my GitHub repo: <a href="https://github.com/guidemetothemoon/div-dev-resources/tree/main/scripts/kubernetes/pluto">guidemetothemoon/div-dev-resources</a></p>
<p>I will not go through all of the installation and execution instructions in detail since all this information is available in the official documentation. What you need to know about the installation part is that Pluto can be installed directly from the binaries that are available on GitHub or with <code>asdf</code> plugin, <code>brew</code> or <code>scoop</code> depending on what OS you're using. More information regarding installation can be found here: <a href="https://pluto.docs.fairwinds.com/installation/">Pluto - Installation</a>.</p>
<p>When it comes to execution, there are 3 main commands you need to know of:</p>
<ul>
<li><code>pluto detect-files</code> command is used for detecting and scanning resources other than Helm charts, like Kubernetes YAML templates, in a specified directory.</li>
<li><code>pluto detect-helm</code> command is used for detecting and scanning Helm charts deployed in a running Kubernetes cluster.</li>
<li><code>pluto detect</code> command is used for scanning a Helm chart that isn't deployed, i.e. outside of a running Kubernetes cluster. For example, a Helm chart located in the source code.</li>
</ul>
<p>There are a few other commands that you can use to customize Pluto execution even further like targeting a specific Kubernetes version, adding custom version checks, etc. You can find more information about available commands here <a href="https://pluto.docs.fairwinds.com/advanced">Pluto - Advanced Usage</a> or by running <code>pluto -h</code> command.</p>
<p>Now, let's take a look at how these commands can be used in different scenarios.</p>
<h3 id="in-cluster-helm-chart-scanning">In-cluster Helm Chart scanning</h3>
<p>You can run Pluto towards an active Kubernetes cluster, either locally from your command line or as part of CI/CD pipeline. Before you run below commands, please ensure that the user you're running with has necessary permissions set in the cluster and that the current context is set to the Kubernetes cluster you want to use. Once it's done you can detect and scan Helm charts in your cluster with help of this command:</p>
<p><code>pluto detect-helm -owide</code></p>
<p>If you want to limit it to a single namespace you can update the command like this:</p>
<p><code>pluto detect-helm -owide -n [namespace_to_scan]</code></p>
<p>If any deprecated or removed API versions have been detected in some of your resources, output will look similar to the one below:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">NAME                                 NAMESPACE   KIND                VERSION          REPLACEMENT   DEPRECATED   DEPRECATED IN   REMOVED   REMOVED IN
</span></span><span class="line"><span class="cl">kubecost/kubecost-grafana             kubecost    PodSecurityPolicy   policy/v1beta1                 true         v1.21.0         false     v1.25.0
</span></span><span class="line"><span class="cl">kubecost/kubecost-cost-analyzer-psp   kubecost    PodSecurityPolicy   policy/v1beta1                 true         v1.21.0         false     v1.25.0
</span></span></code></pre></div><p>As you can see, Pluto provides quite a lot of information that may help you update the resources that are using deprecated/removed APIs.</p>
<h3 id="cicd---azure-devops">CI/CD -&gt; Azure DevOps</h3>
<p>Pluto doesn't have an Azure DevOps extension that you could use directly in Azure Pipelines so you will need to use a script that downloads Pluto and executes the commands you want. I have created an example of a build pipeline definition and a script that you could use to achieve this.</p>
<p>Let's take a look at the pipeline first. You will need to check out those Azure DevOps repositories where you want Pluto to scan for deprecated and removed Kubernetes API versions. Then you will need to install Pluto on a build agent and call a script that runs all the necessary Pluto commands. An example of pipeline definition is provided below - replace <code>project_name</code> with Azure DevOps project name and <code>repository_name</code> with Azure DevOps repository name that you want to scan:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="c"># api-deprecations-pipeline.yml</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">trigger</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span>- <span class="l">master</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">pool</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">vmImage</span><span class="p">:</span><span class="w"> </span><span class="l">ubuntu-latest</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">resources</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">repositories</span><span class="p">:</span><span class="w"> </span><span class="c">#check out those repositories that you want to scan with Pluto</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="nt">repository</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="l">repository_name]</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l">git</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="l">project_name/repository_name]</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">ref</span><span class="p">:</span><span class="w"> </span><span class="l">master  </span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">steps</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span>- <span class="nt">checkout</span><span class="p">:</span><span class="w"> </span><span class="l">self</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">submodules</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">persistCredentials</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span>- <span class="nt">checkout</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;[repository_name]&#39;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">submodules</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">persistCredentials</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span>- <span class="nt">task</span><span class="p">:</span><span class="w"> </span><span class="l">CmdLine@2</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">displayName</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;Install Pluto&#39;</span><span class="w"> </span><span class="c"># update Pluto version if needed in wget and tar command</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">inputs</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">script</span><span class="p">:</span><span class="w"> </span><span class="p">|</span><span class="sd">
</span></span></span><span class="line"><span class="cl"><span class="sd">      sudo apt-get update
</span></span></span><span class="line"><span class="cl"><span class="sd">      echo Downloading Pluto...
</span></span></span><span class="line"><span class="cl"><span class="sd">      wget github.com/FairwindsOps/pluto/releases/download/v5.10.1/pluto_5.10.1_linux_amd64.tar.gz
</span></span></span><span class="line"><span class="cl"><span class="sd">      tar xzvf pluto_5.10.1_linux_amd64.tar.gz
</span></span></span><span class="line"><span class="cl"><span class="sd">      echo Pluto downloaded successfully!</span><span class="w">      
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span>- <span class="nt">task</span><span class="p">:</span><span class="w"> </span><span class="l">Bash@3</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">displayName</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;Run Kubernetes API deprecations validation with Pluto&#39;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">inputs</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">filePath</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;$(System.DefaultWorkingDirectory)/validate-kube-api-deprecations.sh&#39;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">arguments</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;$(System.DefaultWorkingDirectory)&#39;</span><span class="w"> </span><span class="c"># This argument lets the script know the location for checked out repos</span><span class="w">
</span></span></span></code></pre></div><p>As you can see in the last build task, we're calling a script that will execute the scan with Pluto. Let's check it out.</p>
<p>I've created a Bash script that can be used as a template that you can customize to your needs. As an argument it requires a path to the working directory where the repos are located - in our case it's default working directory in Azure DevOps. What the script does is that for every checked out repository it will first detect and scan non-Helm resources like Kubernetes YAML templates with help of <code>pluto detect-files</code> command. Then it will attempt to locate Helm charts and if any Helm charts exist, the script will render each Helm chart based on the standard <code>values.yaml</code> file and use <code>pluto detect</code> command to scan it further for deprecated and removed API versions.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="ln"> 1</span><span class="cl"><span class="c1"># scan-api-deprecations.sh</span>
</span></span><span class="line"><span class="ln"> 2</span><span class="cl">
</span></span><span class="line"><span class="ln"> 3</span><span class="cl"><span class="nv">reposToScan</span><span class="o">=(</span><span class="s2">&#34;[repository_name&#34;</span><span class="o">)</span> <span class="c1"># in case of multiple repos, separate them with whitespace, f.ex. (&#34;repo1&#34; &#34;repo2&#34; &#34;repo3&#34;)</span>
</span></span><span class="line"><span class="ln"> 4</span><span class="cl">      
</span></span><span class="line"><span class="ln"> 5</span><span class="cl"><span class="k">for</span> repo in <span class="s2">&#34;</span><span class="si">${</span><span class="nv">reposToScan</span><span class="p">[@]</span><span class="si">}</span><span class="s2">&#34;</span><span class="p">;</span> <span class="k">do</span>
</span></span><span class="line"><span class="ln"> 6</span><span class="cl">    <span class="nv">repoDir</span><span class="o">=</span><span class="s2">&#34;</span><span class="nv">$1</span><span class="s2">/</span><span class="nv">$repo</span><span class="s2">&#34;</span>
</span></span><span class="line"><span class="ln"> 7</span><span class="cl">
</span></span><span class="line"><span class="ln"> 8</span><span class="cl">    <span class="nb">printf</span> <span class="s2">&#34;\n*********** </span><span class="nv">$repo</span><span class="s2"> ************\n&#34;</span>
</span></span><span class="line"><span class="ln"> 9</span><span class="cl">    <span class="nb">printf</span> <span class="s2">&#34;\nYAML TEMPLATES:\n&#34;</span>
</span></span><span class="line"><span class="ln">10</span><span class="cl">    ./pluto detect-files -d <span class="s2">&#34;</span><span class="nv">$repoDir</span><span class="s2">&#34;</span> -o markdown --ignore-deprecations --ignore-removals <span class="c1"># 2 last parameters can be removed if you want script to fail in case deprecations/removals have been detected</span>
</span></span><span class="line"><span class="ln">11</span><span class="cl">
</span></span><span class="line"><span class="ln">12</span><span class="cl">    <span class="nv">IFS</span><span class="o">=</span><span class="s1">$&#39;\n&#39;</span>
</span></span><span class="line"><span class="ln">13</span><span class="cl">    <span class="nv">helmChartsDir</span><span class="o">=(</span><span class="k">$(</span>find <span class="s2">&#34;</span><span class="nv">$repoDir</span><span class="s2">&#34;</span> -type f -iname <span class="s2">&#34;Chart.yaml&#34;</span><span class="k">)</span><span class="o">)</span>
</span></span><span class="line"><span class="ln">14</span><span class="cl">    <span class="nb">printf</span> <span class="s2">&#34;\nHELM TEMPLATES:\n&#34;</span>
</span></span><span class="line"><span class="ln">15</span><span class="cl">
</span></span><span class="line"><span class="ln">16</span><span class="cl">    <span class="k">if</span> <span class="o">[</span> -z <span class="s2">&#34;</span><span class="nv">$helmChartsDir</span><span class="s2">&#34;</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
</span></span><span class="line"><span class="ln">17</span><span class="cl">        <span class="nb">echo</span> <span class="s2">&#34;No Helm templates found!&#34;</span>
</span></span><span class="line"><span class="ln">18</span><span class="cl">        <span class="k">continue</span>
</span></span><span class="line"><span class="ln">19</span><span class="cl">    <span class="k">fi</span>
</span></span><span class="line"><span class="ln">20</span><span class="cl">
</span></span><span class="line"><span class="ln">21</span><span class="cl">    <span class="k">for</span> helmChartDir in <span class="s2">&#34;</span><span class="si">${</span><span class="nv">helmChartsDir</span><span class="p">[@]</span><span class="si">}</span><span class="s2">&#34;</span><span class="p">;</span> <span class="k">do</span>
</span></span><span class="line"><span class="ln">22</span><span class="cl">        <span class="nb">printf</span> <span class="s2">&#34;\nLocated Helm Chart:</span><span class="nv">$helmChartDir</span><span class="s2">\n&#34;</span>
</span></span><span class="line"><span class="ln">23</span><span class="cl">        <span class="nv">helmChartBaseDir</span><span class="o">=</span><span class="s2">&#34;</span><span class="k">$(</span>dirname <span class="s2">&#34;</span><span class="si">${</span><span class="nv">helmChartDir</span><span class="si">}</span><span class="s2">&#34;</span><span class="k">)</span><span class="s2">&#34;</span>
</span></span><span class="line"><span class="ln">24</span><span class="cl">
</span></span><span class="line"><span class="ln">25</span><span class="cl">        <span class="nv">helmValuesFile</span><span class="o">=</span><span class="k">$(</span>find <span class="s2">&#34;</span><span class="nv">$helmChartBaseDir</span><span class="s2">&#34;</span> -type f -iname <span class="s2">&#34;values.yaml&#34;</span><span class="k">)</span>
</span></span><span class="line"><span class="ln">26</span><span class="cl">        
</span></span><span class="line"><span class="ln">27</span><span class="cl">        <span class="nb">printf</span> <span class="s2">&#34;\nLocated Helm values file:</span><span class="nv">$helmValuesFile</span><span class="s2"> -&gt; checking...\n&#34;</span>
</span></span><span class="line"><span class="ln">28</span><span class="cl">        helm template <span class="s2">&#34;</span><span class="nv">$helmChartBaseDir</span><span class="s2">&#34;</span> -f <span class="s2">&#34;</span><span class="nv">$helmValuesFile</span><span class="s2">&#34;</span> <span class="p">|</span> ./pluto detect - -o markdown --ignore-deprecations --ignore-removals 
</span></span><span class="line"><span class="ln">29</span><span class="cl">    <span class="k">done</span>
</span></span><span class="line"><span class="ln">30</span><span class="cl">    <span class="nb">printf</span> <span class="s2">&#34;\n*******************************\n&#34;</span>
</span></span><span class="line"><span class="ln">31</span><span class="cl"><span class="k">done</span>
</span></span><span class="line"><span class="ln">32</span><span class="cl">      
</span></span><span class="line"><span class="ln">33</span><span class="cl"><span class="nb">echo</span> <span class="s2">&#34;Pluto executed scanning successfully!&#34;</span>
</span></span></code></pre></div><p>If you're using custom Helm values file you can replace line 25 -&gt; <code>helmValuesFile=$(find &quot;$helmChartBaseDir&quot; -type f -iname &quot;values.yaml&quot;)</code> of the script above with the code block below and customize regex expression according to the file names you're using in your projects. In my example, it's <code>values-prod.yaml</code> or <code>deploy-values.yaml</code>.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="nv">helmValuesFile</span><span class="o">=</span><span class="k">$(</span>find <span class="s2">&#34;</span><span class="nv">$helmChartBaseDir</span><span class="s2">&#34;</span> -type f -regextype posix-extended -iregex <span class="s1">&#39;.*values-prod.yaml|.*deploy-values.yaml&#39;</span><span class="k">)</span>
</span></span><span class="line"><span class="cl"><span class="k">if</span> <span class="o">[</span> -z <span class="s2">&#34;</span><span class="nv">$helmValuesFile</span><span class="s2">&#34;</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span> 
</span></span><span class="line"><span class="cl">   <span class="nv">helmValuesFile</span><span class="o">=</span><span class="k">$(</span>find <span class="s2">&#34;</span><span class="nv">$helmChartBaseDir</span><span class="s2">&#34;</span> -type f -iname <span class="s2">&#34;values.yaml&#34;</span><span class="k">)</span>
</span></span><span class="line"><span class="cl"><span class="k">fi</span>
</span></span></code></pre></div><p>The output in the build pipeline will look something like this:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-txt" data-lang="txt"><span class="line"><span class="cl">*********** my-repo-name ************
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">YAML TEMPLATES:
</span></span><span class="line"><span class="cl">|            NAME            |     NAMESPACE     |     KIND      |         VERSION          |    REPLACEMENT     | DEPRECATED | DEPRECATED IN | REMOVED | REMOVED IN |
</span></span><span class="line"><span class="cl">|----------------------------|-------------------|---------------|--------------------------|--------------------|------------|---------------|---------|------------|
</span></span><span class="line"><span class="cl">| letsencrypt-http01-prod    | &lt;UNKNOWN&gt;         | ClusterIssuer | cert-manager.io/v1alpha2 | cert-manager.io/v1 | true       | v1.4.0        | false   | v1.6.0     |
</span></span><span class="line"><span class="cl">| letsencrypt-http01-staging | &lt;UNKNOWN&gt;         | ClusterIssuer | cert-manager.io/v1alpha2 | cert-manager.io/v1 | true       | v1.4.0        | false   | v1.6.0     |
</span></span><span class="line"><span class="cl">| testservicea-tls-cert      | testservicea      | Certificate   | cert-manager.io/v1alpha2 | cert-manager.io/v1 | true       | v1.4.0        | false   | v1.6.0     |
</span></span><span class="line"><span class="cl">| testserviceb-tls-cert      | testserviceb      | Certificate   | cert-manager.io/v1alpha2 | cert-manager.io/v1 | true       | v1.4.0        | false   | v1.6.0     |
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">HELM TEMPLATES:
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">Located Helm Chart:/home/vsts/work/1/s/my-repo-name/test-service-a/helm/test-service-a/Chart.yaml
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">Located Helm values file:/home/vsts/work/1/s/my-repo-name/test-service-a/helm/test-service-a/Chart.yaml/deploy-values-prod.yaml -&gt; checking...
</span></span><span class="line"><span class="cl">|                       NAME                       | NAMESPACE |          KIND           |       VERSION       |  REPLACEMENT   | DEPRECATED | DEPRECATED IN | REMOVED | REMOVED IN |
</span></span><span class="line"><span class="cl">|--------------------------------------------------|-----------|-------------------------|---------------------|----------------|------------|---------------|---------|------------|
</span></span><span class="line"><span class="cl">| test-service-a-pdb                               | &lt;UNKNOWN&gt; | PodDisruptionBudget     | policy/v1beta1      | policy/v1      | true       | v1.21.0       | false   | v1.25.0    |
</span></span><span class="line"><span class="cl">| test-service-a-hpa                               | &lt;UNKNOWN&gt; | HorizontalPodAutoscaler | autoscaling/v2beta1 | autoscaling/v2 | true       | v1.22.0       | false   | v1.25.0    |
</span></span></code></pre></div><p>The script above is configured to succeed even though deprecated or removed API versions have been detected. If you want the build to fail you can update the script and remove <code>--ignore-deprecations</code> and <code>--ignore-removals</code> parameters. For more information on Pluto error codes, check here: <a href="https://pluto.docs.fairwinds.com/advanced/#ci-pipelines">Pluto - CI Pipelines</a>.</p>
<h3 id="cicd---github-actions">CI/CD -&gt; GitHub Actions</h3>
<p>If you want to run Pluto as part of your GitHub workflow, there is a separate GitHub action that you can use to download Pluto. For executing Pluto there is no separate GitHub action but you can use Pluto commands directly:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl">- <span class="nt">uses</span><span class="p">:</span><span class="w"> </span><span class="l">actions/checkout@v2</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">Install Pluto</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">uses</span><span class="p">:</span><span class="w"> </span><span class="l">FairwindsOps/pluto/github-action@master</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">Run Kubernetes API deprecations validation with Pluto</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">run</span><span class="p">:</span><span class="w"> </span><span class="p">|</span><span class="sd">
</span></span></span><span class="line"><span class="cl"><span class="sd">    pluto detect-files -d &#34;[nonhelm_templates_dirpath]&#34; -o markdown --ignore-deprecations --ignore-removals
</span></span></span><span class="line"><span class="cl"><span class="sd">    helm template &#34;[helm_chart_dirpath]&#34; -f &#34;[helm_chart_dirpath]/values.yaml&#34; | pluto detect - -o markdown --ignore-deprecations --ignore-removals</span><span class="w">    
</span></span></span></code></pre></div><p>You can find a working example of running Pluto as part of GitHub workflow in my repo: <a href="https://github.com/guidemetothemoon/div-dev-resources/blob/main/.github/workflows/kubernetes-pluto-gha.yml">guidemetothemoon - kubernetes-pluto-gha.yml</a>.</p>
<h3 id="local-files">Local files</h3>
<p>Finally, if you want to scan resources locally, outside of CI/CD pipeline, you can trigger the same script that we used with Azure Pipelines in the section above, and provide a folder to scan as an input to the script, like this:
<code>./scan-api-deprecations.sh '[repo_dirpath_to_scan]'</code></p>
<h2 id="alternative-tools">Alternative tools</h2>
<p>There are a few other tools available that serve the same purpose as Pluto which is good for you to know about, so that you have all the information needed to take the best decision depending on your scenario. I've chosen Pluto due to it's simplicity, easy installation, support for both in-cluster scanning and scanning of static files residing in the source code outside of a running Kubernetes cluster. In addition, as part of the output Pluto lets you know which version of Kubernetes the deprecated API will be removed in and what the replacement API is. All in all, Pluto just had all the functionality needed to cover the needs in my scenario. And it may be the case for you as well!üòâ</p>
<ul>
<li><a href="https://github.com/doitintl/kube-no-trouble">kubent</a>: quite popular alternative to Pluto, was initially developed to perform scanning in the running Kubernetes cluster but support for specifying file name was added back in 2020. From what I can see you need to explicitly provide file names that you want to scan and it's not supported to provide a directory name, like for example in Pluto. Also, it doesn't look like it's supported to check Helm charts locally, i.e. outside of the running cluster.</li>
<li><a href="https://github.com/derailed/popeye">popeye</a>: first of all, I need to say that I just love the colorfullness of this tool!üò∏ Popeye is a Kubernetes cluster sanitizer which checks a running cluster towards a collection of best practices and can integrate data it collects with your Kubernetes metrics server. There's a limited number of resources it currently supports: Nodes, Namespaces, Pods and Services. It doesn't support scanning static manifests.</li>
<li><a href="https://github.com/wayfair-incubator/kdave">kdave</a>: this tool and the one below are quite new and are being developed by the same contributors from the company called Wayfair. kdave supports exporting data about deprecated and removed API versions in a Prometheus metrics format. It includes 2 components: kdave-server to check deployed Helm releases in a running Kubernetes cluster and kdave-cli to check resources locally or as part of CI/CD. From what I could find CLI does supports both Helm charts and other sources like Kubernetes YAML templates. kdave-server supports only Helm charts.</li>
<li><a href="https://github.com/wayfair-incubator/k8s-used-api-versions">k8s-used-api-versions</a>: a Kubernetes Operator that collects information about deprecated and removed API versions from various resources in the running Kubernetes cluster. Supports exproting this informaiton in a Prometheus metrics format. Runs only in-cluster.</li>
</ul>
<p><strong>Do you know of any other tools that should be added to this list? Let me know!</strong> üòº</p>
<h2 id="additional-resources">Additional resources</h2>
<p>Below you may find a few resources that may be helpful for you when working with Pluto and Kubernetes API deprecations in general:</p>
<ul>
<li><a href="https://github.com/guidemetothemoon/div-dev-resources/blob/main/scripts/kubernetes/pluto">Scripts and templates used in this blog post</a></li>
<li><a href="https://github.com/guidemetothemoon/div-dev-resources/blob/main/.github/workflows/kubernetes-pluto-gha.yml">GitHub CI/CD example with Pluto</a></li>
<li><a href="https://github.com/FairwindsOps/pluto">Pluto - GitHub repo</a></li>
<li><a href="https://kubernetes.io/docs/reference/using-api/deprecation-guide">Kubernetes - Deprecated API Migration Guide</a></li>
</ul>
<p>That's it from me this time, thanks for checking in!üíñ</p>
<p>If this article was helpful, I'd love to hear about it! You can reach out to me on LinkedIn, Twitter, GitHub or by using the contact form on this page.üò∫</p>
<p>Stay secure, stay safe.</p>
<p>Till we connect again!üòª</p>
</div>
    <div class="post__footer">
      

      
        <span><a class="tag" href="/tags/kubernetes/">kubernetes</a><a class="tag" href="/tags/aks/">aks</a><a class="tag" href="/tags/k8s/">k8s</a><a class="tag" href="/tags/azure/">azure</a><a class="tag" href="/tags/devops/">devops</a></span>


      
    </div>

    
  </div>

      </main>
    </div><footer class="footer footer__base">
  <ul class="footer__list">
    <li class="footer__item">
      &copy;
      
        2023 - Powered by Hugo
      
    </li>
    
  </ul>
</footer>
  
  <script
    type="text/javascript"
    src="/js/medium-zoom.min.1248fa75275e5ef0cbef27e8c1e27dc507c445ae3a2c7d2ed0be0809555dac64.js"
    integrity="sha256-Ekj6dSdeXvDL7yfoweJ9xQfERa46LH0u0L4ICVVdrGQ="
    crossorigin="anonymous"
  ></script></body>
</html>
